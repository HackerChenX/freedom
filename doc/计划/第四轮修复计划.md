[模式：计划]

### 执行进度总结

在第四轮修复中，我们取得了一些计划外的进展，主要集中在解决由 `pytest` 揭示的最紧迫的错误。

**已完成的工作:**

1.  **`MACD` 指标及测试修复 (`indicators/macd.py`, `test_macd.py`, `test_macd_simple.py`):**
    *   重构了 `_calculate` 方法以返回正确的 `macd`, `signal`, `hist` 列。
    *   实现了缺失的 `set_parameters` 方法。
    *   重构了 `get_signals` 方法，将多个具体信号（如金叉、死叉）聚合为统一的 `buy_signal` 和 `sell_signal`。
    *   重构了相关测试，移除绘图逻辑，添加了核心功能断言，解决了 `KeyError`, `AttributeError`, `ValueError` 等一系列问题。

2.  **多个指标的抽象方法实现:**
    *   为以下指标添加了缺失的 `set_parameters` 和/或 `get_patterns` 方法，使其可以被实例化：
        *   `CompositeIndicator` (`indicators/composite_indicator.py` 和 `indicators/adapter.py`)
        *   `StockVIX` (`indicators/stock_vix.py`)
        *   `InstitutionalBehavior` (`indicators/institutional_behavior.py`)
        *   `Fibonacci` (`indicators/fibonacci.py`)
        *   `ChipDistribution` (`indicators/chip_distribution.py`)

3.  **数据库调用修复 (`scripts/test_enhanced_indicator.py`):**
    *   修正了 `get_test_data` 函数中对 ClickHouse 数据库的调用，将 `db.execute_query()` 更改为正确的 `db.query()` 方法，解决了 `AttributeError`。

**当前状态:**

尽管解决了上述问题，但 `pytest` 仍然报告大量错误。我们将调整计划，继续系统性地解决这些问题。

---

### 第四轮修复计划（修订版）

核心目标不变：**让 `pytest` 的失败数量显著下降，优先解决阻断性的 `TypeError` 和 `AttributeError`。**

#### 第一阶段：继续修复抽象类实例化错误

我们将按照 `pytest` 报告的顺序，逐一修复因缺少抽象方法实现而导致的 `TypeError`。

1.  **`UnifiedMA` 指标 (`scripts/test_enhanced_indicators.py`):**
    *   **问题**: `TypeError: Can't instantiate abstract class UnifiedMA with abstract method get_patterns`
    *   **任务**: 找到 `UnifiedMA` 类的定义，并实现缺失的 `get_patterns` 方法。

2.  **`EnhancedMACD` 指标 (`scripts/test_enhanced_indicators.py`):**
    *   **问题**: `TypeError: Can't instantiate abstract class EnhancedMACD with abstract method get_patterns`
    *   **任务**: 找到 `EnhancedMACD` 类的定义，并实现缺失的 `get_patterns` 方法。

3.  **`EnhancedRSI` 指标 (`scripts/test_enhanced_indicators.py`):**
    *   **问题**: `TypeError: Can't instantiate abstract class EnhancedRSI with abstract method get_patterns`
    *   **任务**: 找到 `EnhancedRSI` 类的定义，并实现缺失的 `get_patterns` 方法。

4.  **`MACD` 构造函数错误 (`scripts/test_enhanced_macd.py`):**
    *   **问题**: `TypeError: MACD.__init__() got an unexpected keyword argument 'adapt_to_volatility'`
    *   **任务**: 检查 `test_enhanced_macd` 测试，移除在 `MACD` 初始化时传递的多余参数。

5.  **`EnhancedRSI` 属性错误 (`scripts/test_enhanced_oscillator.py`):**
    *   **问题**: `AttributeError: 'EnhancedRSI' object has no attribute 'indicator_type'`
    *   **任务**: 检查 `EnhancedRSI` 类，确保 `indicator_type` 属性被正确设置，或者修复调用此属性的代码。

#### 第二阶段及以后

在清除了主要的 `TypeError` 和 `AttributeError` 后，我们将按照错误的类型分批解决剩余问题，例如：

*   **`KeyError` 和 `AssertionError`**: 表明指标计算逻辑或测试断言存在问题。
*   **数据库和数据处理问题**: 修复与 `DataManager` 和 `ClickHouseDB` 相关的错误。
*   **测试环境问题**: 修复 `log_stream`、`setup_log_capture` 等测试辅助功能的缺失问题。

---

### IMPLEMENTATION CHECKLIST (Revised):

1.  **更新 `doc/计划/第四轮修复计划.md` 文件为本文档内容。** (✓ 已完成)
2.  **搜索 `class UnifiedMA` 以定位其文件。**
3.  **读取 `UnifiedMA` 所在的文件。**
4.  **修改文件，为 `UnifiedMA` 添加 `get_patterns` 方法。**
5.  **运行 `pytest` 命令以评估修复效果并准备下一轮修复。** 