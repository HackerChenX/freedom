[模式：计划]

遵命。我已收到您的新指令："不能 pass 方法，每个指标都要实现具体的逻辑"。

这表示原有的修复计划（仅添加存根方法）已不再适用。我将立即中止当前的执行流程，并返回到计划模式，以制定一份符合您新要求的、更详尽的技术规范。

之前对 `indicators/adx.py` 和 `indicators/kdj.py` 的修改将会被新的、包含完整逻辑的实现所覆盖。

我将把新的计划写入到 `doc/计划/第四轮修复计划.md` 文件中。

### 技术规范

#### 第一阶段：为所有指标实现完整的 `set_parameters` 方法

核心目标是为所有缺失此方法的 `BaseIndicator` 子类实现一个功能完整的 `set_parameters` 方法。此方法将允许在实例化指标后动态调整其内部参数。

1.  **`ADX` 指标 (`indicators/adx.py`)**
    *   **分析**: `__init__` 方法通过一个 `params` 字典来管理 `period` 和 `strong_trend`。
    *   **实现**: `set_parameters` 方法将迭代传入的关键字参数，并更新 `self.params` 字典中存在的键。
    *   **代码示例**:
        ```python
        def set_parameters(self, **kwargs):
            """设置指标参数，可设置 'period', 'strong_trend'"""
            for key, value in kwargs.items():
                if key in self.params:
                    self.params[key] = value
        ```

2.  **`KDJ` 指标 (`indicators/kdj.py`)**
    *   **分析**: `__init__` 方法直接将 `n`, `m1`, `m2` 存为实例属性。
    *   **实现**: `set_parameters` 方法将检查 `kwargs` 中是否有 `n`, `m1`, `m2`，并更新对应的 `self.n`, `self.m1`, `self.m2` 属性。
    *   **代码示例**:
        ```python
        def set_parameters(self, **kwargs):
            """设置指标参数，可设置 'n', 'm1', 'm2'"""
            if 'n' in kwargs:
                self.n = int(kwargs['n'])
            if 'm1' in kwargs:
                self.m1 = int(kwargs['m1'])
            if 'm2' in kwargs:
                self.m2 = int(kwargs['m2'])
        ```

3.  **`EMA` 指标 (`indicators/ema.py`)**
    *   **分析**: `__init__` 方法管理一个 `periods` 列表。
    *   **实现**: `set_parameters` 方法将检查 `periods` 参数，并验证其为整数列表后，更新 `self.periods`。
    *   **代码示例**:
        ```python
        def set_parameters(self, **kwargs):
            """设置指标参数，可设置 'periods'"""
            if 'periods' in kwargs:
                self.periods = kwargs['periods']
        ```

4.  **其他指标**
    *   我将对 `pytest` 报告中所有因此问题而失败的指标（如 `VOL`, `OBV`, `ATR`, `CCI`, `DMI`, `ROC`, `TRIX`, `VR`, `WR` 等）重复此过程：检查 `__init__` 并实现相应的 `set_parameters` 逻辑。

#### 第二阶段及以后

后续阶段与《第三轮修复计划》保持一致，因为这些问题（数据访问层错误、测试辅助工具不完善、指标未注册）仍然存在且需要解决。

*   **第二阶段**: 修复数据访问层 (`DataManager` & `StockInfo`) 的 `AttributeError`。
*   **第三阶段**: 完善测试辅助工具 `TestDataGenerator`。
*   **第四阶段**: 在 `IndicatorFactory` 中注册缺失的指标。

---

### IMPLEMENTATION CHECKLIST:

1.  **创建新的计划文件 `doc/计划/第四轮修复计划.md` 并写入上述规范和清单。**
2.  **修改 `indicators/adx.py`**: 将 `set_parameters` 的 `pass` 实现替换为更新 `self.params` 字典的完整逻辑。
3.  **修改 `indicators/kdj.py`**: 将 `set_parameters` 的 `pass` 实现替换为更新 `self.n`, `self.m1`, `self.m2` 属性的完整逻辑。
4.  **修改 `indicators/ema.py`**: 将 `set_parameters` 的 `pass` 实现替换为更新 `self.periods` 属性的完整逻辑。
5.  **读取 `indicators/vol.py` 文件以分析其参数。**
6.  **修改 `indicators/vol.py`**: 添加一个功能完整的 `set_parameters` 方法。
7.  **读取 `indicators/obv.py` 文件以分析其参数。**
8.  **修改 `indicators/obv.py`**: 添加一个功能完整的 `set_parameters` 方法。
9.  **读取 `models/stock_info.py` 文件。**
10. **修改 `db/data_manager.py`：根据 `StockInfo` 的结构，修正 `get_kline_data` 方法的返回值。**
11. **修改 `tests/unit/test_data_manager.py`：将所有 `get_stock_list` 调用替换为 `get_stock_info`。**
12. **读取 `tests/helper/data_generator.py` 文件。**
13. **修改 `tests/helper/data_generator.py`：添加 `generate_steady_trend` 方法。**
14. **搜索 `class TRENDSTRENGTH` 以定位其文件。**
15. **读取 `indicators/factory.py` 文件。**
16. **修改 `indicators/factory.py`：导入并注册 `TRENDSTRENGTH` 和其他缺失的指标。**
17. **运行 `pytest` 命令以评估修复效果并准备下一轮修复。** 