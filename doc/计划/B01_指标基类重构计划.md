[模式: 计划]

# B01 - 指标基类重构计划

## 1. 计划目标

重构 `BaseIndicator` 类，剥离非核心功能，使其成为一个职责单一的抽象基类。此举旨在提高代码库的可维护性、清晰度和扩展性。

## 2. 关联需求

- 来自《指标基础设施分析报告》的建议。

## 3. 实施检查清单

### 第一阶段：创建工具模块并迁移通用函数

1.  **创建 `utils/indicator_utils.py` 文件**：用于存放从 `BaseIndicator` 迁移出来的所有**极其通用**的技术计算函数。
2.  **迁移静态工具函数**：将以下静态方法从 `indicators/base_indicator.py` 剪切并粘贴到 `utils/indicator_utils.py` 中：
    *   `crossover`
    *   `crossunder`
    *   `sma`
    *   `ema`
    *   `highest`
    *   `lowest`
    *   `atr`
    *   `ensure_columns`

### 第二阶段：重构 `BaseIndicator`

3.  **移除已迁移的静态方法**：在 `indicators/base_indicator.py` 中删除上一步已迁移的所有静态方法。
4.  **移除具体的分析逻辑和策略层方法**：在 `indicators/base_indicator.py` 中彻底删除以下方法的实现，因为它们属于具体分析或策略层，不应存在于基类中：
    *   `detect_market_environment`
    *   `calculate_momentum`
    *   `calculate_volume_trend`
    *   `calculate_breakout_score`
    *   `apply_market_environment_adjustment`
    *   `generate_trading_signals`
    *   `evaluate_signal_quality`
5.  **简化计算入口**：在 `indicators/base_indicator.py` 中，删除冗余的计算方法 `compute`, `safe_compute`, `generate_signals`，只保留 `calculate` 作为统一的公共入口。
6.  **抽象化 `calculate_confidence` 方法**：将 `calculate_confidence` 方法从具体实现改为抽象方法 (`@abc.abstractmethod`)，强制子类根据自身特点提供实现。

### 第三阶段：适配下游指标实现

7.  **适配 `indicators/kdj.py`**：
    *   修改导入语句，从 `utils.indicator_utils` 导入 `crossover` 和 `crossunder`，而不是从 `indicators.common`。
    *   在 `KDJ` 类中，为 `calculate_confidence` 方法提供一个具体的实现（可以先返回一个固定值如 `1.0`）。
    *   在 `calculate_score` 方法中，移除对 `apply_market_environment_adjustment` 的调用。
8.  **适配 `indicators/macd.py`**：
    *   检查并确保 `MACD` 类没有调用任何已从 `BaseIndicator` 中移除的方法。

### 第四阶段：收尾

9.  **最终动作**：运行 `pytest tests/unit/test_kdj.py` 和 `python test_macd_simple.py`，确保在重构后，现有的（尽管不足的）测试仍然能够通过，证明重构没有破坏现有基本功能。 