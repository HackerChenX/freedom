[模式：计划]

## 数据库初始化流程修复计划

本计划旨在详细说明如何修复和改进数据库的自动化初始化流程。此计划严格遵循[创新]阶段确定的最佳方案，即通过读取和执行`sql/`目录下的SQL文件来完成数据库的初始化。

### 1. 环境准备与文件规范

1.1. **创建`sql/ddl`目录**:
    - **操作**: 在`sql/`目录下创建一个名为`ddl`的子目录。
    - **目的**: 专门用于存放数据定义语言（DDL）文件，实现DDL与DML等其他SQL脚本的分离，提高项目的可维护性。
    - **路径**: `sql/ddl/`

1.2. **迁移并重命名`create_new_table.sql`**:
    - **操作**: 将现有的`sql/create_new_table.sql`文件移动到新创建的`sql/ddl/`目录中，并将其重命名为`01_create_stock_info_table.sql`。
    - **目的**: 使用数字前缀确保当未来存在多个DDL文件时，它们能够按照预期的顺序被执行。

1.3. **更新`01_create_stock_info_table.sql`内容**:
    - **操作**: 编辑文件内容，将表名`stock_info_new`修改为最终表名`stock_info`。
    - **目的**: 消除对`rename_table.sql`脚本的依赖，简化整个初始化流程。

### 2. 在`db/clickhouse_db.py`中实现核心逻辑

2.1. **引入必要模块**:
    - **操作**: 在文件顶部添加`import os`。
    - **目的**: 用于处理文件和目录路径。

2.2. **实现`init_database`方法**:
    - **操作**: 在`ClickHouseDB`类中，添加一个新的公共方法`init_database(self)`。
    - **目的**: 作为数据库初始化的主入口点，封装所有初始化步骤。

2.3. **实现`_create_database`私有方法**:
    - **操作**: 在`ClickHouseDB`类中，创建一个名为`_create_database(self)`的私有方法。
    - **目的**: 该方法将执行`CREATE DATABASE IF NOT EXISTS`语句来确保数据库存在。数据库名称将从`self.client.database`属性中动态获取，以增强灵活性。

2.4. **实现`_execute_sql_from_file`私有方法**:
    - **操作**: 在`ClickHouseDB`类中，创建一个名为`_execute_sql_from_file(self, file_path)`的私有方法。
    - **目的**: 接收一个文件路径作为参数，读取文件内容，并执行其中的SQL语句。

2.5. **实现`_run_ddl_scripts`私有方法**:
    - **操作**: 在`ClickHouseDB`类中，创建一个名为`_run_ddl_scripts(self)`的私有方法。
    - **目的**: 该方法将：
        - 构建`sql/ddl`目录的绝对路径。
        - 检查目录是否存在。
        - 如果存在，则遍历目录下的所有`.sql`文件，并按文件名升序排序。
        - 对每个文件调用`_execute_sql_from_file`方法来执行。

### 3. 更新调用方代码

3.1. **修改`bin/init_db.py`**:
    - **操作**: 无需修改。
    - **原因**: 该脚本已通过`db.init_database()`调用，与新实现的方法签名一致。

3.2. **修改`scripts/akshare_to_clickhouse.py`**:
    - **操作**: 无需修改。
    - **原因**: 该脚本中的`init_clickhouse`方法已通过`db.init_database()`调用，与新实现的方法签名一致。

### 4. 清理废弃文件

为保持项目整洁，以下脚本在完成重构后应被删除：

4.1. **删除`sql/copy_data.sql`**:
    - **原因**: 初始化流程不再依赖于从旧表复制数据。
4.2. **删除`sql/rename_table.sql`**:
    - **原因**: DDL文件将直接创建最终的`stock_info`表。
4.3. **删除`sql/create_new_table.sql`**:
    - **原因**: 该文件已被移动和重命名。

---
### IMPLEMENTATION CHECKLIST:

1.  在`sql/`目录下创建`ddl/`子目录。
2.  将`sql/create_new_table.sql`移动到`sql/ddl/`并重命名为`01_create_stock_info_table.sql`。
3.  修改`sql/ddl/01_create_stock_info_table.sql`，将表名从`stock_info_new`改为`stock_info`。
4.  在`db/clickhouse_db.py`文件顶部添加`import os`。
5.  在`db/clickhouse_db.py`的`ClickHouseDB`类中实现`_create_database(self)`私有方法。
6.  在`db/clickhouse_db.py`的`ClickHouseDB`类中实现`_execute_sql_from_file(self, file_path)`私有方法。
7.  在`db/clickhouse_db.py`的`ClickHouseDB`类中实现`_run_ddl_scripts(self)`私有方法。
8.  在`db/clickhouse_db.py`的`ClickHouseDB`类中实现`init_database(self)`公共方法，该方法应依次调用`_create_database()`和`_run_ddl_scripts()`。
9.  确认`bin/init_db.py`中的调用逻辑`db.init_database()`保持不变。
10. 确认`scripts/akshare_to_clickhouse.py`中的调用逻辑`db.init_database()`保持不变。
11. 删除`sql/copy_data.sql`文件。
12. 删除`sql/rename_table.sql`文件。
13. 删除`sql/create_new_table.sql`文件。 