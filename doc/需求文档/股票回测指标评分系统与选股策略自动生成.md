[模式：创新]

# 需求文档：股票回测指标评分系统与选股策略自动生成

## 1. 项目背景与目标

### 1.1 背景

当前系统已实现了基础的回测、指标计算和选股功能，但存在架构问题和功能缺失，需要进行重构和增强，以实现更精确、高效的股票分析和选股系统。

### 1.2 核心目标

1. 构建统一的指标评分系统，为所有技术指标提供标准化的评分机制
2. 完善技术形态识别，将所有形态识别逻辑封装在各自指标类中
3. 按"周期+指标"维度重构回测分析架构
4. 增强共性特征识别能力，全面分析买点共性
5. 实现精确的回测结果到选股策略的自动转换
6. 确保所有数据来源于ClickHouse数据库

## 2. 功能需求

### 2.1 统一指标评分系统

#### 2.1.1 指标评分标准
- 每个技术指标必须实现标准化的评分接口，返回0-100的评分值
- 评分计算应考虑指标当前值、历史统计特性和技术形态
- 评分结果应反映指标信号的强度和可靠性

#### 2.1.2 指标形态评分权重
- 不同技术形态应有不同评分权重
- 信号明确的形态(如金叉)权重高于模糊形态(如接近支撑位)
- 形态组合出现时应提供组合评分算法

#### 2.1.3 评分历史跟踪
- 记录指标评分的历史变化
- 提供评分动量分析(评分变化速度和方向)
- 支持评分交叉和背离分析

### 2.2 指标形态识别封装

#### 2.2.1 形态识别标准化
- 所有技术形态识别逻辑必须封装在各自的指标类中
- 每个指标类必须实现`get_patterns()`方法，返回当前形态列表
- 形态识别结果应包含形态名称、形态强度、形态持续天数等信息

#### 2.2.2 形态注册机制
- 实现形态注册表，管理所有可识别的技术形态
- 每种形态必须有唯一标识符、显示名称和描述
- 支持按指标类型、周期等维度查询可用形态

#### 2.2.3 复合形态识别
- 支持跨指标的复合形态识别(如MACD金叉+KDJ金叉)
- 提供形态序列分析(形态出现的先后顺序)
- 实现形态持续性分析(形态保持的时间)

### 2.3 周期与指标分析架构

#### 2.3.1 周期分离机制
- 严格区分不同周期的指标分析
- 同名指标在不同周期视为不同分析单元
- 分析结果按周期组织，确保周期隔离

#### 2.3.2 多周期数据管理
- 实现高效的多周期数据获取和管理
- 针对不同周期设置不同的最小数据量要求
- 提供周期数据缓存机制，避免重复查询

#### 2.3.3 周期关联分析
- 提供周期关联分析功能(如日线与周线对比)
- 支持多周期共振分析(同一指标在多个周期同时发出信号)
- 实现周期转换和对比可视化

### 2.4 回测系统增强

#### 2.4.1 买点回测功能
- 支持多股票、多买点日期的批量回测
- 对每个买点进行前向数据分析，计算各指标在买点日期的状态
- 按"周期+指标"维度组织回测结果

#### 2.4.2 回测参数配置
- 支持指定回测的指标列表和周期列表
- 允许设置回测前置天数(买点前多少天的数据用于分析)
- 提供回测结果筛选和排序功能

#### 2.4.3 回测结果分析
- 计算各"周期+指标+形态"组合的出现频率和准确率
- 分析形态组合和序列模式
- 评估各指标对买点贡献度的量化分析

### 2.5 共性特征分析增强

#### 2.5.1 全面特征分析
- 不限制分析的特征数量，对所有出现的形态进行统计
- 按周期和指标维度分组统计形态出现频率
- 识别高频、高准确率的形态组合

#### 2.5.2 特征关联分析
- 分析特征之间的关联性和互补性
- 发现特征出现的时序模式
- 建立特征权重评估模型

#### 2.5.3 特征筛选机制
- 提供基于频率、准确率、稳定性等多维度的特征筛选
- 支持交互式特征选择和调整
- 实现特征组合优化算法

### 2.6 可配置选股策略生成

#### 2.6.1 策略配置格式
- 设计统一的策略配置格式，支持JSON/YAML格式
- 配置应包含策略元数据、条件定义、组合规则等
- 支持"周期+指标+形态"的精确描述

#### 2.6.2 策略自动生成
- 基于回测结果自动生成选股策略配置
- 智能分配各条件的权重
- 生成多个候选策略供选择

#### 2.6.3 策略调优接口
- 提供策略手动调整功能
- 支持策略参数敏感性分析
- 实现策略历史表现评估

### 2.7 选股策略执行

#### 2.7.1 策略执行引擎
- 开发高效的策略执行引擎，支持大规模股票池筛选
- 实现条件评估和组合逻辑处理
- 提供实时和批量选股模式

#### 2.7.2 策略验证功能
- 对生成的策略进行历史回测验证
- 验证策略在买点日期是否能正确选出参与回测的股票
- 计算策略的准确率、召回率等评估指标

#### 2.7.3 选股结果展示
- 展示符合策略的股票列表及匹配分数
- 提供各条件的满足情况明细
- 支持结果导出和可视化

### 2.8 数据源管理

#### 2.8.1 ClickHouse数据查询
- 所有回测数据必须从ClickHouse数据库查询
- 优化查询性能，支持大规模数据高效获取
- 实现数据查询缓存机制

#### 2.8.2 数据完整性检查
- 检查必要数据的完整性和有效性
- 对数据异常进行处理和记录
- 提供数据质量报告

#### 2.8.3 数据更新机制
- 支持增量数据更新
- 实现数据更新后的缓存刷新
- 提供数据同步状态监控

## 3. 技术架构设计

### 3.1 核心组件

#### 3.1.1 指标系统
- **指标工厂(IndicatorFactory)**: 负责创建和管理所有指标实例
- **指标注册表(IndicatorRegistry)**: 管理指标元数据和参数映射
- **形态识别器(PatternRecognizer)**: 提供通用的形态识别功能
- **指标评分器(IndicatorScorer)**: 实现统一的指标评分机制

#### 3.1.2 回测系统
- **回测引擎(BacktestEngine)**: 执行多股票多买点的回测分析
- **周期管理器(PeriodManager)**: 管理不同周期的数据和分析
- **特征分析器(FeatureAnalyzer)**: 分析回测结果中的共性特征
- **策略生成器(StrategyGenerator)**: 基于回测结果生成选股策略

#### 3.1.3 选股系统
- **策略解析器(StrategyParser)**: 解析策略配置
- **策略执行器(StrategyExecutor)**: 执行选股策略
- **条件评估器(ConditionEvaluator)**: 评估股票是否满足策略条件
- **策略验证器(StrategyValidator)**: 验证策略的有效性

#### 3.1.4 数据访问层
- **数据查询服务(DataQueryService)**: 提供高效的数据查询接口
- **ClickHouse连接管理器(ClickHouseManager)**: 管理数据库连接
- **数据缓存服务(DataCacheService)**: 实现数据缓存功能
- **数据转换器(DataTransformer)**: 处理数据格式转换

### 3.2 数据模型

#### 3.2.1 指标数据模型
```json
{
  "indicator_id": "KDJ",
  "display_name": "随机指标",
  "parameters": {
    "n": 9,
    "m1": 3,
    "m2": 3
  },
  "patterns": [
    {
      "pattern_id": "KDJ_GOLDEN_CROSS",
      "display_name": "KDJ金叉",
      "description": "K线从下方穿越D线",
      "strength": 85
    },
    // 更多形态...
  ],
  "scoring_rules": {
    "base_score": 50,
    "pattern_weights": {
      "KDJ_GOLDEN_CROSS": 30,
      "KDJ_OVERSOLD": 20,
      // 更多权重...
    }
  }
}
```

#### 3.2.2 回测结果数据模型
```json
{
  "backtest_id": "BT20240601001",
  "stocks": ["000001.SZ", "600000.SH", "..."],
  "buy_points": [
    {
      "stock_code": "000001.SZ",
      "date": "20240115",
      "analysis_results": {
        "daily": {
          "KDJ": {
            "patterns": ["KDJ_GOLDEN_CROSS", "KDJ_OVERSOLD"],
            "score": 85,
            "values": {"K": 25.3, "D": 20.1, "J": 35.8}
          },
          // 更多日线指标...
        },
        "weekly": {
          "KDJ": {
            "patterns": ["KDJ_ABOVE_50"],
            "score": 65,
            "values": {"K": 55.3, "D": 50.1, "J": 65.8}
          },
          // 更多周线指标...
        }
      }
    },
    // 更多买点...
  ],
  "common_features": {
    "daily": [
      {
        "indicator": "KDJ",
        "pattern": "KDJ_GOLDEN_CROSS",
        "frequency": 0.85,
        "accuracy": 0.75,
        "weight": 0.3
      },
      // 更多特征...
    ],
    "weekly": [
      // 周线特征...
    ]
  }
}
```

#### 3.2.3 策略配置数据模型
```json
{
  "strategy_id": "ST20240601001",
  "strategy_name": "多周期KDJ+MACD策略",
  "source": "backtest",
  "backtest_id": "BT20240601001",
  "conditions": [
    {
      "period": "daily",
      "indicator": "KDJ",
      "pattern": "KDJ_GOLDEN_CROSS",
      "weight": 0.3
    },
    {
      "period": "daily",
      "indicator": "MACD",
      "pattern": "MACD_GOLDEN_CROSS",
      "weight": 0.25
    },
    {
      "period": "weekly",
      "indicator": "KDJ",
      "pattern": "KDJ_ABOVE_50",
      "weight": 0.2
    },
    // 更多条件...
  ],
  "combination_rule": {
    "method": "weighted_sum",
    "threshold": 0.6,
    "min_conditions": 2
  },
  "filters": [
    // 基础筛选条件...
  ]
}
```

## 4. 接口设计

### 4.1 指标系统接口

#### 4.1.1 BaseIndicator抽象类
```python
class BaseIndicator:
    """所有指标的基类"""
    
    def __init__(self, name, parameters=None):
        """初始化指标"""
        self.name = name
        self.parameters = parameters or {}
        
    def calculate(self, data):
        """计算指标值，由子类实现"""
        raise NotImplementedError
        
    def get_patterns(self, data=None):
        """识别当前形态，由子类实现"""
        raise NotImplementedError
        
    def calculate_score(self, data=None):
        """计算指标评分，由子类实现"""
        raise NotImplementedError
```

#### 4.1.2 IndicatorFactory工厂类
```python
class IndicatorFactory:
    """指标工厂，负责创建指标实例"""
    
    @classmethod
    def create_indicator(cls, indicator_id, parameters=None):
        """创建指标实例"""
        # 实现指标创建逻辑
        
    @classmethod
    def get_indicator_metadata(cls, indicator_id):
        """获取指标元数据"""
        # 实现元数据获取逻辑
```

#### 4.1.3 具体指标类示例
```python
class KDJIndicator(BaseIndicator):
    """KDJ随机指标实现"""
    
    indicator_id = "KDJ"
    display_name = "随机指标"
    
    def __init__(self, n=9, m1=3, m2=3):
        """初始化KDJ指标"""
        super().__init__(self.display_name)
        self.n = n
        self.m1 = m1
        self.m2 = m2
        
    def calculate(self, data):
        """计算KDJ值"""
        # 实现KDJ计算逻辑
        
    def get_patterns(self, data=None):
        """识别KDJ形态"""
        patterns = []
        # 实现形态识别逻辑
        # 例如：检测金叉、死叉、超买、超卖等
        return patterns
        
    def calculate_score(self, data=None):
        """计算KDJ评分"""
        score = 50  # 基础分
        # 实现评分逻辑
        # 考虑当前值、形态、历史表现等
        return score
```

### 4.2 回测系统接口

#### 4.2.1 BacktestEngine类
```python
class BacktestEngine:
    """回测引擎，执行多股票多买点的回测分析"""
    
    def __init__(self, db_manager=None):
        """初始化回测引擎"""
        self.db_manager = db_manager or get_clickhouse_db()
        self.period_manager = PeriodManager()
        
    def run_backtest(self, stock_codes, buy_dates, periods=None, indicators=None, days_before=20):
        """执行回测分析"""
        # 实现回测逻辑
        
    def analyze_common_features(self, backtest_results):
        """分析共性特征"""
        # 实现特征分析逻辑
        
    def generate_strategy(self, backtest_results, strategy_name=None):
        """生成选股策略"""
        # 实现策略生成逻辑
```

#### 4.2.2 PeriodManager类
```python
class PeriodManager:
    """周期管理器，管理不同周期的数据和分析"""
    
    def get_period_data(self, stock_code, start_date, end_date, period):
        """获取指定周期的数据"""
        # 实现数据获取逻辑
        
    def convert_period(self, data, from_period, to_period):
        """转换数据周期"""
        # 实现周期转换逻辑
```

### 4.3 选股系统接口

#### 4.3.1 StrategyExecutor类
```python
class StrategyExecutor:
    """策略执行器，执行选股策略"""
    
    def __init__(self, db_manager=None):
        """初始化策略执行器"""
        self.db_manager = db_manager or get_clickhouse_db()
        self.condition_evaluator = ConditionEvaluator()
        
    def execute_strategy(self, strategy_config, stock_pool=None, date=None):
        """执行选股策略"""
        # 实现策略执行逻辑
        
    def validate_strategy(self, strategy_config, backtest_results):
        """验证策略有效性"""
        # 实现策略验证逻辑
```

#### 4.3.2 ConditionEvaluator类
```python
class ConditionEvaluator:
    """条件评估器，评估股票是否满足策略条件"""
    
    def evaluate_condition(self, condition, stock_data):
        """评估单个条件"""
        # 实现条件评估逻辑
        
    def evaluate_combined_conditions(self, conditions, stock_data, combination_rule):
        """评估组合条件"""
        # 实现组合条件评估逻辑
```

## 5. 实现计划

### 5.1 阶段划分

#### 5.1.1 第一阶段：基础架构重构
- 重构指标系统，实现统一的形态识别和评分接口
- 重构周期管理机制，确保周期隔离
- 改进数据访问层，确保所有数据来自ClickHouse

#### 5.1.2 第二阶段：核心功能实现
- 开发增强的回测引擎
- 实现全面的共性特征分析
- 开发策略自动生成功能

#### 5.1.3 第三阶段：集成与验证
- 集成指标系统、回测系统和选股系统
- 实现策略验证功能
- 完善用户接口和文档

### 5.2 优先级排序

1. 指标形态识别封装 - 高优先级
2. 周期与指标分析架构重构 - 高优先级
3. 统一指标评分系统 - 高优先级
4. 回测引擎增强 - 中优先级
5. 共性特征分析改进 - 中优先级
6. 策略自动生成功能 - 中优先级
7. 策略验证功能 - 低优先级
8. 用户界面优化 - 低优先级

## 6. 验收标准

### 6.1 功能验收标准

1. 所有技术指标必须实现形态识别和评分功能
2. 回测系统必须正确区分不同周期的同名指标
3. 共性特征分析必须全面分析所有出现的形态
4. 自动生成的选股策略必须能够在买点日期选出参与回测的股票
5. 所有数据必须来自ClickHouse数据库

### 6.2 性能验收标准

1. 支持同时分析至少500只股票的多买点回测
2. 回测分析耗时不超过10分钟(对于1000个买点)
3. 选股策略执行时间不超过1分钟(对于全市场股票)
4. 系统内存占用不超过8GB

### 6.3 扩展性验收标准

1. 能够轻松添加新的技术指标
2. 支持自定义形态识别规则
3. 支持自定义评分算法
4. 能够集成第三方数据源

## 7. 风险与限制

### 7.1 已识别风险

1. 数据质量风险：ClickHouse数据库中的数据可能存在质量问题
2. 性能风险：大规模数据处理可能导致性能问题
3. 复杂度风险：系统复杂度增加可能导致维护困难

### 7.2 限制条件

1. 技术指标只能基于可获取的市场数据计算
2. 回测结果不能保证未来表现
3. 计算资源有限，可能限制分析规模

## 8. 附录

### 8.1 术语表

- **技术形态**：指标呈现的特定模式，如金叉、死叉、超买、超卖等
- **买点**：认为适合买入的时间点
- **周期**：数据的时间单位，如日线、周线、月线等
- **共性特征**：多个买点共有的技术形态或指标特征
- **选股策略**：用于筛选股票的一组条件和规则

### 8.2 参考文档

- 当前回测系统与指标系统及选股系统结合分析
- 回测系统问题分析与改进方案
- 回测结果转换选股策略实施指南
- 回测系统指标补充实现总结
- 回测系统指标覆盖情况分析
