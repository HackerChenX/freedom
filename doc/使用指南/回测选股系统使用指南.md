# 回测选股系统使用指南

## 一、系统概述

回测选股系统是一个集成的工具，用于分析股票买点特征，提取共性指标，并自动生成可配置的选股策略。该系统包含两个核心组件：

1. **回测分析系统**：分析历史买点的技术特征和形态
2. **可配置选股系统**：根据回测结果生成选股策略并执行选股

## 二、功能流程

系统的基本工作流程如下：

1. 准备买点数据（CSV格式）
2. 确保数据库中有足够的股票历史数据
3. 执行回测分析，提取买点共性特征
4. 生成基于共性特征的选股策略
5. 使用生成的策略在实时市场中进行选股验证

## 三、使用步骤

### 1. 准备买点数据

买点数据应保存为CSV格式，包含以下列：股票代码、日期、买点类型。

示例格式：
```
300005,20250424,趋势反弹
603359,20250509,趋势反弹
002251,20250513,趋势反弹
301536,20250116,趋势反弹
```

可以编辑`examples/buypoints.csv`文件或创建新的CSV文件。确保：
- 股票代码格式正确（A股为6位数字）
- 日期格式为`YYYYMMDD`
- 买点类型正确（如"趋势反弹"、"突破回踩"等）

### 2. 准备股票数据

系统依赖ClickHouse数据库中的股票历史数据。需确保：

1. 数据库连接配置正确（默认配置在`config/user_config.json`中）
2. `stock_info`表中包含足够的历史数据

如需导入新的股票数据，可使用以下命令：
```bash
python scripts/akshare_to_clickhouse.py --codes 股票代码1,股票代码2,...
```

### 3. 执行回测分析

使用以下命令执行回测分析：
```bash
python bin/run_backtest.py --input <买点文件路径> --type <买点类型>
```

例如：
```bash
python bin/run_backtest.py --input examples/buypoints.csv --type 趋势反弹
```

参数说明：
- `--input`：买点数据文件路径
- `--type`：买点类型，用于筛选CSV文件中的特定类型（可选）

### 4. 分析回测结果

回测完成后，系统会生成以下文件：
- JSON格式结果：`data/result/回测结果/buypoints_<类型>_<时间戳>.json`
- Markdown格式报告：`data/result/回测结果/buypoints_<类型>_<时间戳>.md`
- 策略文件：`data/result/回测结果/strategies/strategy_<时间戳>.py`

查看Markdown报告了解：
- 买点的共性技术形态和特征
- 推荐的选股策略
- 各股票的具体分析结果

### 5. 生成选股策略

回测系统会自动根据分析结果生成选股策略。生成的策略包括：

1. **ZXM体系选股策略**：基于趋势、弹性、买点三个维度的综合策略
2. **通用技术形态选股策略**：基于必要条件、重要条件、确认条件的组合策略

策略代码保存在`data/result/回测结果/strategies/`目录下。

### 6. 验证选股策略

使用生成的策略在当前市场环境中进行选股验证：

```bash
python bin/stock_select.py --strategy <策略文件路径>
```

例如：
```bash
python bin/stock_select.py --strategy data/result/回测结果/strategies/strategy_20250527163606.py
```

也可以在不指定具体策略文件的情况下，使用策略名称：
```bash
python bin/stock_select.py --strategy_name 趋势反弹
```

## 四、常见问题

### 数据库连接问题

如果遇到数据库连接错误，请检查：
- 数据库服务是否正常运行
- 配置文件中的连接信息是否正确
- 防火墙是否允许连接

### 数据不足问题

如遇到"没有检测到任何模式"或"没有足够的数据生成策略"的提示，原因可能是：
- 数据库中缺少足够的历史数据
- 买点数据不足或格式错误
- 分析的股票无法形成有效的共性特征

解决方法：
- 增加更多的买点数据
- 确保数据库中有完整的股票历史数据
- 尝试分析同类型的买点

### 策略生成问题

如果生成的策略不符合预期，可以：
- 检查买点数据的质量和数量
- 修改策略代码调整指标参数
- 增加不同类型的技术指标

## 五、高级应用

### 自定义买点类型

除了使用预定义的买点类型，还可以自定义买点类型进行分析：
1. 在CSV文件中使用自定义的买点类型名称
2. 执行回测时指定相同的类型名称

### 选股策略优化

生成的策略可能需要进一步优化：
1. 修改策略代码中的指标参数
2. 添加新的技术指标或筛选条件
3. 结合基本面指标进行选股

### 策略回测与评估

可以对生成的策略进行历史回测和评估：
```bash
python bin/strategy_backtest.py --strategy <策略文件路径> --start_date <开始日期> --end_date <结束日期>
```

## 六、附录

### 支持的技术指标

系统支持以下类型的技术指标：
- 趋势类指标：MA、EMA、MACD、BIAS、BOLL等
- 震荡类指标：KDJ、RSI、WR、CCI等
- 量能类指标：VOL、OBV、VOSC、MFI等
- 形态类指标：K线形态、突破形态、反转形态等
- 特色指标：ZXM买点分类、吸筹形态、洗盘形态等

### 参考资源

- 系统设计文档：`doc/系统设计/可配置选股系统设计方案.md`
- 需求文档：`doc/需求文档/可配置选股系统需求文档.md`
- 系统应用：`doc/系统设计/可配置选股系统应用.md` 