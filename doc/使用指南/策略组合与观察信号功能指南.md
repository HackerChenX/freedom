# 策略组合与观察信号功能使用指南

本文档介绍如何使用股票分析系统的策略组合执行和观察信号识别功能，这些功能是可配置选股系统的重要组成部分。

## 1. 功能概述

本系统提供以下核心功能：

1. **策略组合执行**：支持多个策略并行执行，并将结果合并为一个综合评分列表
2. **观察信号识别**：寻找接近触发条件但尚未满足的股票，用于提前发现潜在机会
3. **信号详情分析**：提供单只股票的详细信号分析，包括趋势和历史信息

## 2. 命令行工具

系统提供了命令行工具 `bin/stock_watch.py` 来访问这些功能。工具支持以下子命令：

- `combine`：执行策略组合
- `watch`：寻找观察信号
- `detail`：获取观察信号详情
- `list`：列出可用策略

### 2.1 策略组合执行

策略组合功能允许同时执行多个策略，并根据配置的权重将结果合并为一个综合评分列表。

**基本用法**：

```bash
./bin/stock_watch.py combine -s STRATEGY_ID1,STRATEGY_ID2 [选项]
```

**常用选项**：

- `-s, --strategies`：策略ID列表，以逗号分隔（必需）
- `-w, --weights`：策略权重列表，以逗号分隔（可选，默认权重相等）
- `-p, --pool`：股票池，以逗号分隔（可选，默认使用策略过滤器）
- `-b, --begin_date`：开始日期，格式：YYYY-MM-DD（可选）
- `-e, --end_date`：结束日期，格式：YYYY-MM-DD（可选）
- `-o, --output`：输出文件路径（可选）
- `--parallel`：是否并行执行策略（默认为True）
- `--max_workers`：最大并行工作线程数（默认为5）
- `--save`：是否保存结果到数据库（可选）
- `--analyze`：是否分析策略组合（可选）

**示例**：

```bash
# 组合两个策略，使用默认权重
./bin/stock_watch.py combine -s TREND_REVERSAL,MOMENTUM_BREAKOUT

# 组合两个策略，使用自定义权重，保存结果并分析
./bin/stock_watch.py combine -s TREND_REVERSAL,MOMENTUM_BREAKOUT -w 0.7,0.3 -o result.csv --save --analyze

# 组合三个策略，指定日期范围和自定义股票池
./bin/stock_watch.py combine -s TREND_REVERSAL,MOMENTUM_BREAKOUT,VALUE_INVEST -b 2023-01-01 -e 2023-10-01 -p 600000,601318,000001
```

### 2.2 观察信号识别

观察信号功能用于识别接近触发条件但尚未满足的股票，帮助提前发现潜在机会。

**基本用法**：

```bash
./bin/stock_watch.py watch -s STRATEGY_ID [选项]
```

**常用选项**：

- `-s, --strategy`：策略ID（必需）
- `-p, --pool`：股票池，以逗号分隔（可选，默认使用策略过滤器）
- `-b, --begin_date`：开始日期，格式：YYYY-MM-DD（可选）
- `-e, --end_date`：结束日期，格式：YYYY-MM-DD（可选）
- `-t, --threshold`：接近度阈值（0-1之间，默认0.7）
- `-d, --trend_days`：趋势分析天数（默认3）
- `-o, --output`：输出文件路径（可选）

**示例**：

```bash
# 使用默认参数寻找观察信号
./bin/stock_watch.py watch -s TREND_REVERSAL

# 指定接近度阈值和趋势分析天数
./bin/stock_watch.py watch -s MOMENTUM_BREAKOUT -t 0.8 -d 5 -o watch_signals.csv

# 在自定义股票池中寻找观察信号
./bin/stock_watch.py watch -s VALUE_INVEST -p 600000,601318,000001
```

### 2.3 观察信号详情

观察信号详情功能提供单只股票的详细信号分析，包括各个条件的趋势和历史信息。

**基本用法**：

```bash
./bin/stock_watch.py detail -s STRATEGY_ID -c STOCK_CODE [选项]
```

**常用选项**：

- `-s, --strategy`：策略ID（必需）
- `-c, --code`：股票代码（必需）
- `-b, --begin_date`：开始日期，格式：YYYY-MM-DD（可选）
- `-e, --end_date`：结束日期，格式：YYYY-MM-DD（可选）
- `-d, --days`：回溯天数（默认30）
- `-o, --output`：输出文件路径（可选）

**示例**：

```bash
# 获取股票的观察信号详情
./bin/stock_watch.py detail -s TREND_REVERSAL -c 600000

# 指定回溯天数和输出文件
./bin/stock_watch.py detail -s MOMENTUM_BREAKOUT -c 601318 -d 60 -o detail.json

# 指定日期范围
./bin/stock_watch.py detail -s VALUE_INVEST -c 000001 -b 2023-01-01 -e 2023-10-01
```

### 2.4 列出可用策略

列出系统中可用的策略，便于选择和管理。

**基本用法**：

```bash
./bin/stock_watch.py list [选项]
```

**常用选项**：

- `-a, --all`：显示所有策略信息（可选）
- `-f, --filter`：按名称或描述过滤策略（可选）

**示例**：

```bash
# 列出所有策略
./bin/stock_watch.py list

# 显示所有策略的详细信息
./bin/stock_watch.py list -a

# 按关键词过滤策略
./bin/stock_watch.py list -f 趋势
```

## 3. 通过API使用

除了命令行工具外，还可以在Python代码中直接使用相关API。

### 3.1 策略组合执行

```python
from strategy.strategy_combiner import StrategyCombiner

# 创建策略组合器
combiner = StrategyCombiner()

# 执行策略组合
result = combiner.execute_strategies(
    strategy_ids=["TREND_REVERSAL", "MOMENTUM_BREAKOUT"],
    weights={"TREND_REVERSAL": 0.7, "MOMENTUM_BREAKOUT": 0.3},
    start_date="2023-01-01",
    end_date="2023-10-01"
)

# 分析策略组合
analysis = combiner.get_strategy_analysis(["TREND_REVERSAL", "MOMENTUM_BREAKOUT"])
```

### 3.2 观察信号识别

```python
from strategy.signal_watcher import SignalWatcher
from strategy.strategy_manager import StrategyManager

# 获取策略配置
strategy_manager = StrategyManager()
strategy_plan = strategy_manager.get_strategy("TREND_REVERSAL")

# 创建观察信号处理器
watcher = SignalWatcher()

# 寻找观察信号
watch_signals = watcher.find_watch_signals(
    strategy_plan=strategy_plan,
    stock_pool=["600000", "601318", "000001"],
    threshold=0.8,
    trend_days=5
)

# 获取特定股票的详细信号
detail = watcher.get_watch_signal_details(
    stock_code="600000",
    strategy_plan=strategy_plan,
    lookback_days=30
)
```

## 4. 结果解析

### 4.1 策略组合结果

策略组合执行的结果DataFrame包含以下主要字段：

- `stock_code`：股票代码
- `stock_name`：股票名称
- `combined_score`：组合后的总分数
- `strategy_count`：满足的策略数量
- `strategy_details`：各策略的详细信息（JSON字符串）
- `rank`：排名

### 4.2 观察信号结果

观察信号识别的结果DataFrame包含以下主要字段：

- `stock_code`：股票代码
- `stock_name`：股票名称
- `proximity`：接近度（0-1之间）
- `trend_score`：趋势得分（-1到1之间）
- `completion_ratio`：条件完成比例
- `condition_details`：各条件的详细信息（JSON字符串）
- `rank`：排名

### 4.3 观察信号详情结果

观察信号详情结果是一个包含以下主要字段的字典：

- `stock_code`/`stock_name`：股票代码和名称
- `strategy_id`：策略ID
- `start_date`/`end_date`：分析的时间范围
- `condition_details`：各条件的详细信息，包括：
  - `indicator_id`：指标ID
  - `period`：周期
  - `signal_type`：信号类型
  - `parameters`：指标参数
  - `signal_history`：信号历史记录
  - `chart_data`：图表数据，包括价格、指标值和信号

## 5. 使用场景

### 5.1 市场趋势转变时的信号捕捉

在市场趋势转变的初期，使用观察信号功能可以提前发现潜在的买入机会：

```bash
# 寻找趋势反转策略的观察信号
./bin/stock_watch.py watch -s TREND_REVERSAL -t 0.75
```

### 5.2 多策略综合筛选

在进行重要决策时，可以组合多个不同的策略进行综合筛选：

```bash
# 组合技术和基本面策略
./bin/stock_watch.py combine -s TECH_INDICATOR,FUNDAMENTAL_VALUE,INDUSTRY_LEADER -w 0.4,0.4,0.2 --analyze
```

### 5.3 重点股票深度分析

对特定股票进行深度的信号分析，了解其接近满足条件的程度：

```bash
# 分析特定股票在多个策略下的表现
./bin/stock_watch.py detail -s COMPREHENSIVE_STRATEGY -c 600000 -d 60
```

## 6. 注意事项

1. **性能考虑**：在大规模股票池上执行复杂策略组合可能耗时较长，建议使用并行执行功能。
2. **参数调优**：观察信号的阈值设置会影响结果数量，根据需要调整`threshold`参数。
3. **数据依赖**：确保数据库中有足够的历史数据，特别是在进行长期趋势分析时。
4. **策略选择**：不同类型的策略组合在不同市场环境下效果各异，建议根据当前市场特点选择合适的策略。

## 7. 常见问题

1. **为什么观察信号识别没有结果？**
   - 检查阈值设置是否过高，可以尝试降低`threshold`参数
   - 确认策略条件是否合理，过于严格的条件可能导致很少有股票接近满足

2. **如何评估观察信号的质量？**
   - `proximity`值越高，表示越接近满足条件
   - `trend_score`为正值且较大时，表示向好的趋势明显
   - 使用`detail`命令查看详细的信号历史和趋势

3. **如何设置合理的策略权重？**
   - 根据策略的历史表现设置权重
   - 技术面和基本面策略可以考虑均衡配置
   - 使用`--analyze`参数分析不同权重配置的结果差异 