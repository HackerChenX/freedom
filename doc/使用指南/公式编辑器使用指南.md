# 公式编辑器使用指南

## 概述

公式编辑器是选股系统的重要组成部分，提供了将通达信风格公式转换为系统选股策略的能力。通过这个功能，用户可以方便地利用已有的通达信选股公式，无需重新编写选股逻辑，快速创建系统策略。

## 主要功能

1. **公式转换**：将通达信风格公式转换为系统选股策略配置
2. **公式验证**：验证通达信公式的语法正确性
3. **公式测试**：在特定股票上测试公式的执行效果
4. **策略保存**：将转换后的策略保存到系统中

## 命令行工具

系统提供了`bin/formula_to_strategy.py`命令行工具，用于执行公式转换和管理。

### 基本参数

| 参数 | 描述 | 示例 |
| ---- | ---- | ---- |
| `-f, --file` | 通达信公式文件路径 | `--file formulas/my_formula.txt` |
| `-t, --text` | 通达信公式文本 | `--text "MA5>MA10"` |
| `-n, --name` | 策略名称 | `--name "均线交叉策略"` |
| `-d, --desc` | 策略描述 | `--desc "基于均线交叉的短线选股策略"` |
| `-a, --author` | 策略作者 | `--author "trader"` |
| `--validate` | 仅验证公式语法 | `--validate` |
| `--test` | 测试公式，需提供股票代码 | `--test 000001` |
| `--save` | 保存生成的策略 | `--save` |
| `-o, --output` | 输出文件路径 | `--output strategies/my_strategy.json` |
| `--pretty` | 美化输出 | `--pretty` |

### 使用示例

#### 1. 验证公式语法

```bash
python bin/formula_to_strategy.py --file formulas/my_formula.txt --validate
```

#### 2. 测试公式

```bash
python bin/formula_to_strategy.py --file formulas/my_formula.txt --test 000001
```

#### 3. 转换并保存策略

```bash
python bin/formula_to_strategy.py --file formulas/my_formula.txt --name "均线交叉策略" --save
```

#### 4. 转换并导出策略配置

```bash
python bin/formula_to_strategy.py --file formulas/my_formula.txt --output strategies/my_strategy.json --pretty
```

## 通达信公式规范

为了确保公式能被正确转换，通达信公式应遵循以下规范：

### 1. 公式结构

一个标准的通达信公式应包含以下部分：
- 注释部分（可选，使用`{}`或`#`）
- 变量定义部分（使用`:=`或`=`赋值）
- 买入条件部分（最后一行或特定命名的变量）

### 2. 注释规范

支持两种注释方式：
- 单行注释：以`#`开头
- 块注释：用`{}`包围

注释中的第一行将被用作策略名称，其余行将被用作策略描述。

### 3. 变量定义规范

变量定义使用`:=`或`=`赋值，例如：
```
MA5:=MA(CLOSE,5);
MA10:=MA(CLOSE,10);
```

### 4. 买入条件规范

买入条件可以通过以下方式指定：
- 直接在最后一行写出条件表达式
- 定义一个名为`BUY`、`SIGNAL`或`RESULT`的变量

例如：
```
BUY:=MA5>MA10;
```
或
```
MA5>MA10
```

### 5. 支持的函数

公式转换器支持以下通达信函数：

| 函数 | 描述 | 示例 |
| ---- | ---- | ---- |
| `MA` | 移动平均线 | `MA(CLOSE,5)` |
| `EMA` | 指数移动平均线 | `EMA(CLOSE,12)` |
| `SMA` | 简单移动平均线 | `SMA(CLOSE,5,1)` |
| `MACD` | MACD指标 | `MACD(12,26,9)` |
| `KDJ` | KDJ指标 | `KDJ(9,3,3)` |
| `RSI` | RSI指标 | `RSI(14)` |
| `BOLL` | 布林带 | `BOLL(20,2)` |
| `CROSS` | 交叉函数 | `CROSS(MA5,MA10)` |
| `REF` | 引用历史数据 | `REF(CLOSE,1)` |
| `HHV` | 最高值 | `HHV(HIGH,20)` |
| `LLV` | 最低值 | `LLV(LOW,20)` |
| `COUNT` | 统计满足条件的周期数 | `COUNT(CLOSE>REF(CLOSE,1),10)` |

### 6. 支持的操作符

公式转换器支持以下操作符：

| 操作符 | 描述 | 示例 |
| ------ | ---- | ---- |
| `AND` | 逻辑与 | `MA5>MA10 AND MACD>0` |
| `OR` | 逻辑或 | `MA5>MA10 OR MA5>MA20` |
| `NOT` | 逻辑非 | `NOT(CLOSE<OPEN)` |
| `>` | 大于 | `CLOSE>OPEN` |
| `<` | 小于 | `CLOSE<OPEN` |
| `>=` | 大于等于 | `CLOSE>=OPEN` |
| `<=` | 小于等于 | `CLOSE<=OPEN` |
| `=` | 等于 | `CLOSE=OPEN` |
| `<>` | 不等于 | `CLOSE<>OPEN` |

## 公式示例

### 示例1：均线交叉策略

```
{均线交叉策略
短期均线上穿长期均线，寻找上涨趋势}

# 参数设置
N1:=5;
N2:=10;

# 计算均线
MA1:=MA(CLOSE,N1);
MA2:=MA(CLOSE,N2);

# 买入条件
CROSS(MA1,MA2)
```

### 示例2：KDJ超卖回调策略

```
{KDJ超卖回调策略
KDJ指标从超卖区回升，寻找短线反弹机会}

# 计算KDJ指标
RSV:=(CLOSE-LLV(LOW,9))/(HHV(HIGH,9)-LLV(LOW,9))*100;
K:=SMA(RSV,3,1);
D:=SMA(K,3,1);
J:=3*K-2*D;

# 超卖条件
OVERSOLD:=K<20 AND D<20;

# 回调条件
RECOVER:=K>D AND REF(K,1)<=REF(D,1);

# 买入条件
OVERSOLD AND RECOVER
```

### 示例3：MACD金叉策略

```
{MACD金叉策略
MACD金叉且零轴以上，寻找中期趋势机会}

# 计算MACD
SHORT:=EMA(CLOSE,12);
LONG:=EMA(CLOSE,26);
DIF:=SHORT-LONG;
DEA:=EMA(DIF,9);
MACD:=2*(DIF-DEA);

# 金叉条件
GOLDEN_CROSS:=CROSS(DIF,DEA);

# 零轴以上
ABOVE_ZERO:=DIF>0;

# 买入条件
GOLDEN_CROSS AND ABOVE_ZERO
```

## 高级用法

### 自定义指标转换

公式编辑器支持将通达信公式中的自定义指标转换为系统指标。如果公式中使用了系统不支持的自定义指标，您可以：

1. 在公式中直接实现该指标的计算逻辑
2. 在系统中实现对应的指标类，并注册到指标工厂

### 复合条件处理

对于复杂的选股条件，可以使用逻辑运算符组合多个条件：

```
{复合条件策略}

# 技术指标条件
TECH_COND:=MA5>MA10 AND MACD>0;

# 成交量条件
VOL_COND:=VOL>MA(VOL,5)*1.5;

# 价格形态条件
PRICE_COND:=CLOSE>OPEN AND CLOSE>REF(CLOSE,1);

# 买入条件：满足技术指标条件和任一其他条件
TECH_COND AND (VOL_COND OR PRICE_COND)
```

### 多周期处理

对于需要使用不同周期数据的公式，可以在公式注释或变量名中指明周期：

```
{多周期策略}

# 日线指标
MA5_D:=MA(CLOSE,5); # 日线5日均线
MA10_D:=MA(CLOSE,10); # 日线10日均线

# 周线指标 (系统会自动识别"周线"关键词)
MA5_W:=MA(CLOSE,5); # 周线5周均线

# 买入条件
CROSS(MA5_D,MA10_D) AND MA5_W>MA(CLOSE,10)
```

## 常见问题

### 1. 公式转换失败

可能的原因：
- 公式语法错误
- 使用了不支持的函数或操作符
- 变量引用错误

解决方案：
- 使用`--validate`参数检查公式语法
- 简化公式，将复杂表达式拆分为多个简单表达式
- 确保所有变量在使用前已定义

### 2. 转换后策略无法正常工作

可能的原因：
- 公式逻辑与系统逻辑不完全兼容
- 数据处理方式不同
- 函数实现细节不同

解决方案：
- 使用`--test`参数测试公式效果
- 对比通达信和系统的计算结果
- 调整公式或修改系统实现

### 3. 性能问题

可能的原因：
- 公式过于复杂
- 包含大量历史数据引用
- 使用了计算密集型函数

解决方案：
- 简化公式逻辑
- 减少历史数据引用
- 调整公式或优化系统实现

## 总结

公式编辑器为用户提供了便捷的通达信公式转换功能，帮助用户快速将已有的通达信选股公式转换为系统选股策略。通过遵循本指南中的规范和建议，用户可以更有效地利用这一功能，提高选股效率。 