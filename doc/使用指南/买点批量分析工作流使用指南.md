# 买点批量分析工作流使用指南

## 功能概述

买点批量分析工作流是一个自动化工具，用于分析多个股票买点的共性技术指标特征，并将这些共性指标转换为可执行的选股策略。通过提供一个包含股票代码和买点日期的CSV文件，系统会自动分析各个周期下哪些技术指标在买点日期被命中，并提取出多个买点共同具有的技术特征，最终生成一个可用于选股的策略。

## 工作流程

1. 用户提供包含股票代码和买点日期的CSV文件
2. 系统从数据库中获取股票的历史数据（多个周期）
3. 系统分析每个买点在各个周期下命中的技术指标形态
4. 系统提取多个买点共同命中的指标形态（共性指标）
5. 系统根据共性指标生成选股策略
6. 系统输出分析报告和策略文件

## 使用方法

### 准备输入文件

创建一个CSV文件，包含以下列：
- `stock_code`：股票代码
- `buypoint_date`：买点日期（格式为YYYYMMDD或YYYY-MM-DD）

示例（buypoints.csv）：
```
stock_code,buypoint_date
000001,20230315
600036,2023-03-16
601318,20230320
```

### 运行命令

通过命令行运行买点批量分析工具：

```bash
python bin/buypoint_batch_analyzer.py --input examples/buypoints.csv --output data/result/my_analysis
```

#### 命令参数说明

- `--input, -i`：输入的CSV文件路径（必需）
- `--output, -o`：输出目录路径（默认为`data/result/buypoint_analysis`）
- `--min-hit-ratio, -r`：共性指标的最小命中比例，取值范围0-1（默认为0.6，即60%）
- `--strategy-name, -s`：生成策略的名称（默认为`BuyPointCommonStrategy`）
- `--log-level, -l`：日志级别，可选值：DEBUG, INFO, WARNING, ERROR, CRITICAL（默认为INFO）

示例：
```bash
# 使用最小命中率为70%
python bin/buypoint_batch_analyzer.py --input examples/buypoints.csv --output data/result/my_analysis --min-hit-ratio 0.7

# 自定义策略名称
python bin/buypoint_batch_analyzer.py --input examples/buypoints.csv --output data/result/my_analysis --strategy-name MyStrategy

# 使用DEBUG日志级别
python bin/buypoint_batch_analyzer.py --input examples/buypoints.csv --output data/result/my_analysis --log-level DEBUG
```

### 输出结果

分析完成后，系统会在指定的输出目录生成以下文件：

1. `buypoint_analysis.json`：所有买点的详细分析结果
2. `common_indicators.json`：提取出的共性指标
3. `generated_strategy.json`：生成的选股策略
4. `common_indicators_report.md`：共性指标报告（易读格式）

#### 共性指标报告

共性指标报告（`common_indicators_report.md`）是一个易于阅读的Markdown文件，包含以下内容：
- 生成时间
- 各周期下的共性指标列表
- 每个指标的命中率、命中数量和平均得分

示例：
```markdown
# 买点共性指标分析报告

## 生成时间: 2023-04-10 15:30:45

## daily 周期共性指标

| 指标类型 | 指标名称 | 形态 | 命中率 | 命中数量 | 平均得分 |
|---------|----------|------|--------|----------|----------|
| indicator | KDJ | GOLDEN_CROSS | 80.00% | 4 | 85.75 |
| indicator | RSI | OVERBOUGHT | 60.00% | 3 | 72.33 |
| pattern | MORNING_STAR | - | 60.00% | 3 | 68.67 |

## weekly 周期共性指标

| 指标类型 | 指标名称 | 形态 | 命中率 | 命中数量 | 平均得分 |
|---------|----------|------|--------|----------|----------|
| indicator | MACD | GOLDEN_CROSS | 80.00% | 4 | 88.25 |
```

#### 生成的策略

生成的策略（`generated_strategy.json`）是一个JSON文件，包含基于共性指标构建的选股策略。该策略可以直接加载到系统的策略执行引擎中，用于选择具有相似技术特征的股票。

## 注意事项

1. 确保输入的CSV文件格式正确，包含必要的列
2. 输入的买点日期必须是有效的交易日
3. 系统会从数据库中查询股票数据，请确保数据库中有足够的历史数据
4. 调整最小命中比例参数可以控制共性指标的筛选严格程度：
   - 较高的值（如0.8）会产生更严格的筛选，只保留大多数买点都命中的指标
   - 较低的值（如0.5）会产生更宽松的筛选，包含更多的潜在共性指标
5. 生成的策略默认使用"OR"逻辑，即满足任一条件即可选出股票，可以根据需要手动修改策略文件

## 常见问题

### Q: 如何查看分析日志？
A: 日志文件保存在`logs`目录下，文件名格式为`buypoint_analysis_YYYYMMDD_HHMMSS.log`。

### Q: 为什么某些股票没有分析结果？
A: 可能的原因包括：
   - 数据库中没有该股票的历史数据
   - 买点日期不是有效的交易日
   - 分析过程中出现异常（请查看日志）

### Q: 如何使用生成的策略？
A: 可以将生成的策略文件（`generated_strategy.json`）加载到系统的策略执行引擎中：
```python
from strategy.strategy_executor import StrategyExecutor

executor = StrategyExecutor()
strategy = executor.load_strategy_from_file('data/result/my_analysis/generated_strategy.json')
results = executor.execute_strategy(strategy)
```

### Q: 如何调整生成策略的逻辑？
A: 默认情况下，生成的策略使用"OR"逻辑（满足任一条件即可）。如果需要更严格的筛选，可以修改策略文件中的`condition_logic`字段为"AND"，或者手动调整策略条件。 