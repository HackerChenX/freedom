# 增强版回测系统使用指南

本文档介绍如何使用增强版回测系统，该系统解决了原有回测系统中的周期与指标混淆问题，提供了更精细的配置选项和结果管理。

## 1. 系统特点

增强版回测系统具有以下特点：

1. **周期隔离**：严格区分不同周期的同名指标，避免周期混淆
2. **统一形态识别**：使用标准化的形态识别接口和结果格式
3. **统一评分系统**：所有指标使用0-100分制的统一评分标准
4. **灵活配置**：支持精细的回测参数配置
5. **跨周期分析**：提供多周期共性特征和形态关联分析
6. **智能策略生成**：自动生成基于回测结果的选股策略

## 2. 命令行使用

增强版回测系统提供了命令行工具，可通过以下方式使用：

```bash
python bin/run_enhanced_backtest.py -i <输入文件> -o <输出文件> [选项]
```

### 2.1 基本参数

- `-i, --input`: 输入CSV文件路径，包含股票代码和买点日期（必需）
- `-o, --output`: 输出JSON文件路径，保存分析结果（必需）
- `-s, --strategy`: 输出策略文件路径，不指定则不生成策略（可选）

### 2.2 周期与指标配置

- `-p, --periods`: 要分析的周期，逗号分隔，如"DAILY,WEEKLY,MIN60"
- `--indicators`: 要分析的指标，逗号分隔，如"MACD,KDJ,RSI"
- `--disable-indicators`: 禁用的指标，逗号分隔

### 2.3 回测参数

- `--days-before`: 买点前分析天数（默认20）
- `--days-after`: 买点后分析天数（默认10）

### 2.4 策略生成参数

- `--threshold`: 形态出现次数阈值，用于策略生成（默认2）

### 2.5 高级配置

- `--config`: 配置文件路径，JSON格式

### 2.6 使用示例

基本使用：
```bash
python bin/run_enhanced_backtest.py -i data/buy_points.csv -o data/result/analysis_result.json
```

指定周期和指标：
```bash
python bin/run_enhanced_backtest.py -i data/buy_points.csv -o data/result/analysis_result.json -p "DAILY,WEEKLY,MIN60" --indicators "MACD,KDJ,RSI,BOLL"
```

生成策略：
```bash
python bin/run_enhanced_backtest.py -i data/buy_points.csv -o data/result/analysis_result.json -s data/result/strategy.json --threshold 3
```

使用配置文件：
```bash
python bin/run_enhanced_backtest.py -i data/buy_points.csv -o data/result/analysis_result.json --config config/backtest_config.json
```

## 3. 配置文件格式

配置文件使用JSON格式，示例如下：

```json
{
  "days_before": 20,
  "days_after": 10,
  "periods": ["DAILY", "WEEKLY", "MIN60", "MIN30", "MIN15"],
  "indicators": {
    "MACD": {"enabled": true},
    "KDJ": {"enabled": true},
    "RSI": {"enabled": true, "params": {"period": 14}},
    "BOLL": {"enabled": true},
    "MA": {"enabled": true},
    "VOL": {"enabled": false},
    "DMI": {"enabled": true},
    "ATR": {"enabled": true},
    "SAR": {"enabled": true}
  }
}
```

## 4. 输入文件格式

输入文件应为CSV格式，至少包含以下列：

- `code`: 股票代码
- `buy_date`: 买点日期，格式为YYYYMMDD或YYYY-MM-DD

可选列：
- `name`: 股票名称
- `pattern_type`: 买点类型描述

示例：
```csv
code,buy_date,name,pattern_type
000001.SZ,20230215,平安银行,均线多头排列
600519.SH,20230310,贵州茅台,回踩支撑
```

## 5. 输出结果说明

### 5.1 分析结果格式

增强版回测系统输出的分析结果是一个JSON文件，包含以下主要部分：

- `stocks`: 分析的股票列表，每只股票包含：
  - `stock_code`: 股票代码
  - `buy_date`: 买点日期
  - `periods`: 各个周期的分析结果
    - 每个周期包含各个指标的计算结果、形态和评分
  - `common_patterns`: 在多个周期中共同出现的形态
- `pattern_stats`: 各形态的出现次数统计
- `timestamp`: 分析时间戳

### 5.2 策略格式

生成的策略是一个JSON文件，包含以下主要部分：

- `name`: 策略名称
- `description`: 策略描述
- `period_conditions`: 按周期组织的条件
  - 每个周期包含多个指标条件
  - 每个指标条件包含多个形态
- `period_weights`: 各周期的权重
- `metadata`: 策略元数据，包括生成时间、样本数量等

## 6. 编程接口

除了命令行工具外，增强版回测系统还提供了编程接口，可在Python代码中直接使用：

```python
from scripts.backtest.enhanced_backtest import EnhancedBacktest
from enums.period import Period

# 获取回测系统实例
backtest = EnhancedBacktest.get_instance()

# 配置
config = {
    'days_before': 20,
    'days_after': 10,
    'periods': [Period.DAILY, Period.WEEKLY, Period.MIN60],
    'indicators': {
        'MACD': {'enabled': True},
        'KDJ': {'enabled': True},
        'RSI': {'enabled': True}
    }
}

# 分析单个股票
result = backtest.analyze_stock('000001.SZ', '20230215', config)

# 批量分析
results = backtest.batch_analyze('data/buy_points.csv', 'data/result/analysis_result.json', config)

# 生成策略
backtest.generate_strategy(results, 'data/result/strategy.json', threshold=2)
```

## 7. 周期管理器

增强版回测系统使用周期管理器(PeriodManager)处理不同周期的数据需求，可在其他模块中使用：

```python
from utils.period_manager import PeriodManager
from enums.period import Period

# 获取周期管理器实例
period_manager = PeriodManager.get_instance()

# 获取股票数据
data = period_manager.get_data('000001.SZ', Period.DAILY, end_date='20230215')

# 转换周期
weekly_data = period_manager.convert_period(data, Period.DAILY, Period.WEEKLY)

# 获取周期标识符
period_id = period_manager.get_period_id(Period.DAILY)

# 获取指标和周期的组合标识符
indicator_period_id = period_manager.get_indicators_period_id('MACD', Period.DAILY)
```

## 8. 最佳实践

1. **周期选择**：根据分析需求选择合适的周期组合，如日线+周线，或分钟线+日线
2. **指标选择**：避免使用过多指标，优先选择关键指标如MACD、KDJ、RSI、BOLL等
3. **形态筛选**：调整threshold参数，筛选出高频高准确率的形态
4. **分批处理**：对于大量股票，建议分批处理以避免内存问题
5. **结果分析**：关注跨周期共性特征和形态关联，它们通常具有更高的预测价值

## 9. 常见问题

1. **内存不足**：处理大量股票时可能遇到内存不足，建议分批处理或减少周期和指标数量
2. **周期未找到**：确保输入的周期字符串正确，参考Period枚举类
3. **指标计算错误**：检查指标参数是否合理，某些指标可能需要特定的数据量
4. **无法生成策略**：确保分析结果中有足够的形态，可能需要调整threshold参数

## 10. 后续优化方向

1. 共性特征分析完善
2. 策略调优功能实现
3. 条件评估逻辑修复
4. 组合条件处理增强
5. 大规模股票池筛选性能优化 