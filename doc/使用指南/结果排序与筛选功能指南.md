# 结果排序与筛选功能使用指南

## 概述

结果排序与筛选功能是选股系统的重要组成部分，它允许用户对选股结果进行多维度的排序、筛选和分组，从而更精确地获取符合特定条件的股票。此功能集成在选股命令行工具中，可以通过简单的命令行参数使用。

## 主要功能

1. **多维度排序**：支持按一个或多个字段进行排序，如分数、排名、行业等
2. **灵活筛选**：支持多种筛选条件，如分数范围、行业选择、正则表达式等
3. **结果分组**：支持按行业、市值区间等字段进行分组展示
4. **结果增强**：支持自动分析条件满足情况，提取JSON字段中的关键信息等

## 命令行参数

使用`bin/stock_select.py`命令时，可以指定以下排序与筛选相关的参数：

| 参数 | 描述 | 示例 |
| ---- | ---- | ---- |
| `--sort` | 排序字段，格式：字段1:方向,字段2:方向 | `--sort score:desc,rank:asc` |
| `--filter` | 筛选条件，格式：字段:操作符:值 | `--filter score:>:80,industry:in:电子,医药` |
| `--min-score` | 最低分数，等同于 `--filter score:>=:值` | `--min-score 75` |
| `--top` | 只显示前N名，等同于 `--filter rank:<=:值` | `--top 10` |
| `--group-by` | 按字段分组，例如：industry | `--group-by industry` |
| `--enrich` | 增强结果，添加更多信息 | `--enrich` |

## 使用示例

### 基本排序

按分数降序排序：

```bash
python bin/stock_select.py -s strategy_id --sort score:desc
```

多字段排序（先按行业，再按分数）：

```bash
python bin/stock_select.py -s strategy_id --sort industry:asc,score:desc
```

### 条件筛选

筛选分数大于80的股票：

```bash
python bin/stock_select.py -s strategy_id --filter score:>:80
```

筛选特定行业的股票：

```bash
python bin/stock_select.py -s strategy_id --filter industry:in:电子|医药|计算机
```

组合条件筛选：

```bash
python bin/stock_select.py -s strategy_id --filter score:>:70,industry:in:电子|医药
```

使用简化参数（只显示前10名）：

```bash
python bin/stock_select.py -s strategy_id --top 10
```

### 结果分组

按行业分组显示：

```bash
python bin/stock_select.py -s strategy_id --group-by industry
```

分组并排序：

```bash
python bin/stock_select.py -s strategy_id --group-by industry --sort score:desc
```

### 结果增强

增强结果分析：

```bash
python bin/stock_select.py -s strategy_id --enrich
```

增强并筛选：

```bash
python bin/stock_select.py -s strategy_id --enrich --filter condition_count:>=:3
```

### 复杂组合使用

排序、筛选、分组和增强组合使用：

```bash
python bin/stock_select.py -s strategy_id --sort score:desc --min-score 75 --top 20 --group-by industry --enrich
```

## 支持的操作符

在使用`--filter`参数时，支持以下操作符：

| 操作符 | 描述 | 示例 |
| ------ | ---- | ---- |
| `>` | 大于 | `score:>:80` |
| `>=` | 大于等于 | `score:>=:75` |
| `<` | 小于 | `score:<:60` |
| `<=` | 小于等于 | `rank:<=:10` |
| `=` 或 `==` | 等于 | `stock_code:=:000001` |
| `!=` | 不等于 | `stock_code:!=:000001` |
| `in` | 包含于集合 | `industry:in:电子|医药` |
| `not_in` | 不包含于集合 | `industry:not_in:房地产|银行` |
| `between` | 在范围内 | `score:between:70|90` |

## 支持的排序字段

系统支持对以下字段进行排序：

- `score`：得分（默认降序）
- `rank`：排名（默认升序）
- `market_cap`：市值（默认降序）
- `industry`：行业（默认升序）
- `stock_code`：股票代码（默认升序）
- `condition_count`：满足条件数量（默认降序）
- `strategy_count`：满足策略数量（默认降序）
- `combined_score`：组合得分（默认降序）

## 注意事项

1. 在使用复杂的筛选条件时，请确保正确使用格式和操作符
2. 某些特殊字符可能需要在命令行中转义
3. 对于不存在的字段，系统会发出警告并忽略相关操作
4. 结果增强功能可能会增加处理时间，尤其是对大量结果数据
5. 分组展示时，每个组默认只显示前5条记录

## 高级用法

### 结果增强选项

使用`--enrich`参数时，系统会进行以下增强：

1. 分析满足条件数量统计
2. 提取各类指标的满足情况
3. 计算每种指标类型的数量

### 自定义结果处理

如果命令行参数不能满足需求，可以在Python代码中直接使用`ResultFilter`类进行更复杂的处理：

```python
from strategy.result_filter import ResultFilter

# 创建结果过滤器
result_filter = ResultFilter()

# 应用自定义筛选
filtered_result = result_filter.filter_results(result, [
    {"type": "score", "min": 75},
    {"type": "industry", "values": ["电子", "医药"], "exclude": False}
])

# 应用自定义排序
sorted_result = result_filter.sort_results(filtered_result, [
    {"field": "score", "direction": "DESC"},
    {"field": "industry", "direction": "ASC"}
])

# 应用自定义分组
grouped_result = result_filter.group_results(sorted_result, 
                                           group_by="industry", 
                                           sort_field="score", 
                                           top_n=5)

# 应用自定义增强
enriched_result = result_filter.enrich_results(sorted_result, [
    {"type": "condition_stats", "conditions_field": "satisfied_conditions"},
    {"type": "extract_json", "json_field": "strategy_details", "target_field": "best_strategy", "json_path": "best.id"}
])
```

## 实际应用场景

### 场景一：高分股票筛选

筛选分数高于85分的前10只股票：

```bash
python bin/stock_select.py -s strategy_id --min-score 85 --top 10
```

### 场景二：行业龙头分析

按行业分组并显示每个行业得分最高的3只股票：

```bash
python bin/stock_select.py -s strategy_id --group-by industry --sort score:desc --enrich
```

### 场景三：满足多个条件的股票

筛选同时满足至少3个条件且分数大于70的股票：

```bash
python bin/stock_select.py -s strategy_id --enrich --filter condition_count:>=:3,score:>:70
```

### 场景四：特定行业高分股票导出

筛选电子行业分数大于80的股票并导出到CSV：

```bash
python bin/stock_select.py -s strategy_id --filter industry:in:电子,score:>:80 -o results/high_score_electronics.csv
```

## 排错指南

如果在使用过程中遇到问题，请检查：

1. 命令行参数格式是否正确
2. 字段名称是否存在于结果中
3. 操作符是否支持
4. 数值类型是否正确（如分数应为数字）

如果需要查看更详细的错误信息，可以检查日志文件（通常在`logs`目录下）。 