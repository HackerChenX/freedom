# 买点批量分析工作流实现方案

## 工作流概述

本文档详细描述如何实现基于CSV文件的买点批量分析工作流。该工作流允许用户通过输入包含多个个股代码和对应买点日期的CSV文件，系统自动进行批量分析，识别每个买点的指标形态特征，进行多周期分析，并生成全面的分析报告。

## 需求分析

### 输入格式

用户输入一个CSV文件（如`examples/buypoints.csv`），其中包含股票代码和买点日期信息，格式示例：
```
stock_code,buy_date
603359,20250509
603359,20250512
603359,20250513
601888,20240308
...
```

### 处理流程

1. 解析输入的CSV文件
2. 对每个买点进行多周期分析（日线、周线、月线）
3. 识别每个买点命中的指标形态
4. 统计不同周期下的形态分布
5. 生成详细的分析报告

### 输出结果

1. 个股买点详细分析结果（每个买点的指标形态命中情况）
2. 不同周期的形态统计报告
3. 买点质量评估报告
4. 图表可视化展示

## 系统架构设计

### 组件结构

1. **输入处理模块**：解析CSV文件，提取股票代码和买点日期
2. **数据获取模块**：根据股票代码和日期获取多周期K线数据
3. **指标计算模块**：计算各种技术指标
4. **形态识别模块**：识别各种指标形态
5. **统计分析模块**：分析形态分布和共性特征
6. **报告生成模块**：生成分析报告和可视化图表

### 数据流图

```
CSV文件 → 输入处理模块 → 数据获取模块 → 指标计算模块 → 形态识别模块 → 统计分析模块 → 报告生成模块 → 最终报告
```

## 实现方案

### 1. 命令行工具设计

创建一个命令行工具，用于执行批量买点分析：

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
买点批量分析工具

用法:
    python analyze_buypoints.py --input examples/buypoints.csv --output results/analysis_report
    
参数:
    --input: 输入的CSV文件路径，包含股票代码和买点日期
    --output: 输出报告的路径前缀
    --periods: 分析周期，默认为"daily,weekly"
    --indicators: 要分析的指标，默认为所有指标
    --format: 输出格式，支持markdown、html、excel、json
"""

import os
import sys
import argparse
import pandas as pd
from datetime import datetime
from typing import List, Dict, Any, Optional

# 添加项目根目录到Python路径
root_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, root_dir)

from analysis.buypoints.buypoint_analyzer import BuyPointAnalyzer
from analysis.buypoints.buypoint_dimension_analyzer import BuyPointDimensionAnalyzer
from utils.logger import get_logger
from utils.path_utils import get_result_dir

logger = get_logger(__name__)

def parse_arguments():
    """解析命令行参数"""
    parser = argparse.ArgumentParser(description='买点批量分析工具')
    
    parser.add_argument('--input', '-i', required=True, 
                        help='输入的CSV文件路径，包含股票代码和买点日期')
    
    parser.add_argument('--output', '-o', default=None,
                        help='输出报告的路径前缀')
    
    parser.add_argument('--periods', '-p', default='daily,weekly',
                        help='分析周期，以逗号分隔，如"daily,weekly,monthly"')
    
    parser.add_argument('--indicators', default=None,
                        help='要分析的指标，以逗号分隔，默认为所有指标')
    
    parser.add_argument('--format', '-f', default='markdown',
                        choices=['markdown', 'html', 'excel', 'json'],
                        help='输出格式')
    
    return parser.parse_args()

def load_buypoints_csv(file_path: str) -> pd.DataFrame:
    """
    加载买点CSV文件
    
    Args:
        file_path: CSV文件路径
        
    Returns:
        pd.DataFrame: 包含股票代码和买点日期的DataFrame
    """
    try:
        # 读取CSV文件
        df = pd.read_csv(file_path)
        
        # 验证必要的列
        required_columns = ['stock_code', 'buy_date']
        for col in required_columns:
            if col not in df.columns:
                logger.error(f"CSV文件缺少必要的列: {col}")
                raise ValueError(f"CSV文件格式错误，缺少必要的列: {col}")
        
        # 转换日期格式
        if 'buy_date' in df.columns:
            df['buy_date'] = df['buy_date'].astype(str)
        
        logger.info(f"成功加载CSV文件，包含 {len(df)} 个买点")
        return df
    
    except Exception as e:
        logger.error(f"加载CSV文件时出错: {e}")
        raise

def main():
    """主函数"""
    # 解析命令行参数
    args = parse_arguments()
    
    # 加载买点CSV文件
    buypoints_df = load_buypoints_csv(args.input)
    
    # 解析周期参数
    periods = [p.upper() for p in args.periods.split(',')]
    
    # 解析指标参数
    indicators = None
    if args.indicators:
        indicators = args.indicators.split(',')
    
    # 创建输出目录
    if args.output:
        output_dir = os.path.dirname(args.output)
        os.makedirs(output_dir, exist_ok=True)
    else:
        # 使用默认输出目录
        result_dir = get_result_dir()
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        output_dir = os.path.join(result_dir, f"buypoint_analysis_{timestamp}")
        os.makedirs(output_dir, exist_ok=True)
        args.output = os.path.join(output_dir, "analysis_report")
    
    # 创建买点分析器
    analyzer = BuyPointAnalyzer()
    
    # 创建买点维度分析器
    dimension_analyzer = BuyPointDimensionAnalyzer()
    
    # 执行批量分析
    results = analyze_buypoints(
        analyzer, 
        dimension_analyzer,
        buypoints_df, 
        periods, 
        indicators
    )
    
    # 生成报告
    generate_reports(results, args.output, args.format)
    
    logger.info(f"分析完成，报告已保存到: {args.output}")

def analyze_buypoints(analyzer, dimension_analyzer, buypoints_df, periods, indicators):
    """
    执行批量买点分析
    
    Args:
        analyzer: 买点分析器
        dimension_analyzer: 买点维度分析器
        buypoints_df: 买点DataFrame
        periods: 分析周期列表
        indicators: 指标列表
        
    Returns:
        Dict: 分析结果
    """
    # 初始化结果
    results = {
        "individual_results": [],
        "statistics": {},
        "metadata": {
            "total_buypoints": len(buypoints_df),
            "periods": periods,
            "indicators": indicators,
            "analysis_time": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
    }
    
    # 逐个分析买点
    for _, row in buypoints_df.iterrows():
        stock_code = row['stock_code']
        buy_date = row['buy_date']
        stock_name = row.get('stock_name', '')
        
        logger.info(f"分析买点: {stock_code} {stock_name} {buy_date}")
        
        # 分析单个买点
        buypoint_result = analyzer.analyze_buypoint_with_indicators(
            stock_code=stock_code,
            buy_date=buy_date,
            periods=periods,
            indicators=indicators
        )
        
        if buypoint_result:
            results["individual_results"].append(buypoint_result)
    
    # 进行维度分析
    stock_codes = buypoints_df['stock_code'].unique().tolist()
    
    # 确定日期范围
    min_date = min(buypoints_df['buy_date'])
    max_date = max(buypoints_df['buy_date'])
    
    # 添加一些天数以覆盖更多数据
    from datetime import datetime, timedelta
    start_date_obj = datetime.strptime(min_date, "%Y%m%d") - timedelta(days=30)
    end_date_obj = datetime.strptime(max_date, "%Y%m%d") + timedelta(days=10)
    
    start_date = start_date_obj.strftime("%Y%m%d")
    end_date = end_date_obj.strftime("%Y%m%d")
    
    # 针对每个周期进行维度分析
    for period in periods:
        # 进行形态分析
        pattern_results = dimension_analyzer.analyze_pattern_features(
            stock_codes=stock_codes,
            start_date=start_date,
            end_date=end_date,
            period=period
        )
        
        # 进行趋势分析
        trend_results = dimension_analyzer.analyze_trend_features(
            stock_codes=stock_codes,
            start_date=start_date,
            end_date=end_date,
            period=period
        )
        
        # 进行成交量分析
        volume_results = dimension_analyzer.analyze_volume_features(
            stock_codes=stock_codes,
            start_date=start_date,
            end_date=end_date,
            period=period
        )
        
        # 保存该周期的分析结果
        results["statistics"][period] = {
            "pattern_analysis": pattern_results,
            "trend_analysis": trend_results,
            "volume_analysis": volume_results
        }
    
    # 获取综合报告
    results["summary"] = dimension_analyzer.get_comprehensive_report()
    
    return results

def generate_reports(results, output_prefix, format_type):
    """
    生成分析报告
    
    Args:
        results: 分析结果
        output_prefix: 输出文件路径前缀
        format_type: 输出格式
    """
    # 生成个股买点分析报告
    generate_individual_report(results["individual_results"], 
                              f"{output_prefix}_individual", format_type)
    
    # 生成统计分析报告
    generate_statistics_report(results["statistics"], 
                              f"{output_prefix}_statistics", format_type)
    
    # 生成综合报告
    generate_summary_report(results["summary"], 
                           f"{output_prefix}_summary", format_type)
    
    # 如果输出格式为excel，还可以生成一个包含所有报告的Excel文件
    if format_type == 'excel':
        generate_excel_report(results, f"{output_prefix}_all.xlsx")

def generate_individual_report(individual_results, output_path, format_type):
    """生成个股买点分析报告"""
    # 根据输出格式生成报告
    pass

def generate_statistics_report(statistics, output_path, format_type):
    """生成统计分析报告"""
    # 根据输出格式生成报告
    pass

def generate_summary_report(summary, output_path, format_type):
    """生成综合报告"""
    # 根据输出格式生成报告
    pass

def generate_excel_report(results, output_path):
    """生成Excel报告"""
    # 创建Excel文件，包含多个sheet
    pass

if __name__ == "__main__":
    main() 