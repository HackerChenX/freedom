# 指标问题修复计划

## 一、引言
本文档旨在根据《指标问题汇总V2.md》中列出的问题，制定一个详细、可执行的修复计划。计划涵盖了从注册与实例化、数据完整性到工厂注册等六大类问题。每个修复项都包含问题描述、根本原因分析、以及具体的实施步骤和涉及的文件。

## 二、详细修复计划

### 1. 注册与实例化问题
#### 1.1 Enhanced系列指标
- **问题**: 'EnhancedTRIX'/'EnhancedKDJ'等对象缺少'indicator_type'属性。
- **原因**: 增强型指标未正确继承基类属性，或未在构造函数中初始化。
- **文件**: `indicators/enhanced_trix.py`, `indicators/enhanced_kdj.py` (文件名待确认).
- **方案**: 检查`Enhanced`系列指标的基类，并在其 `__init__` 方法中，确保`super().__init__()` 被调用，并正确设置 `self.indicator_type` 属性。

#### 1.2 KC/DMA指标
- **问题**: No module named 'data.model'.
- **原因**: 代码中存在对一个已废弃或不存在的`data.model`模块的依赖。
- **文件**: `indicators/kc.py`, `indicators/dma.py`.
- **方案**: 在上述文件中，移除`import data.model` 或 `from data.model ...` 的语句。审查代码，确保移除后指标的计算逻辑仍然能基于输入的`DataFrame` 正常工作。

#### 1.3 CMO指标
- **问题**: 无法导入`find_peaks`.
- **原因**: `utils/signal_utils.py` 中缺少`find_peaks` 函数。
- **文件**: `utils/signal_utils.py`.
- **方案**: 引入`scipy`库作为依赖。在 `utils/signal_utils.py` 中，从`scipy.signal` 导入`find_peaks` 函数，并封装成项目内部的`find_peaks`工具函数，以供`CMO`指标调用。

### 2. 数据完整性问题
#### 2.1 通用列缺失
- **问题**: 输入数据缺少`open/high/low/close/volume`等基础列。
- **原因**: 数据查询或预处理步骤未能提供指标计算所需的全部基础字段。
- **文件**: `db/clickhouse_db.py` (或其他数据查询模块).
- **方案**: 定位项目中负责查询K线数据的核心函数。修改数据库查询语句，确保对于日线等K线数据，查询结果总是包含`open, high, low, close, volume, turnover_rate`等必要字段。

#### 2.2 特殊列缺失
- **问题**: `BIAS`指标缺少`bias`列；`ZXM`系列指标缺少`capital`列。
- **原因**: BIAS的形态分析依赖其计算结果列；`ZXM`指标依赖一个在当前数据库中不存在的`capital`字段。
- **文件**: `indicators/bias.py`, `indicators/zxm/*`, `analysis/buypoints/auto_indicator_analyzer.py`.
- **方案**:
 - `BIAS`: 在`indicators/bias.py` 的`calculate`方法中，确保计算出的BIAS值被存储在返回`DataFrame`的一个名为`'bias'`的列中。
 - `ZXM`: 根据用户要求，`capital`字段不应再使用。在`indicators/zxm/`目录下，全局搜索`capital`的使用。将其替换为使用已有的`volume`(成交量)和`turnover_rate`(换手率)的计算逻辑。如果某个功能强依赖`capital`且无法替换，则移除该功能并记录警告。

### 3. 形态分析方法问题
#### 3.1 AD指标
- **问题**: 'numpy.bool_' object has no attribute 'iloc'.
- **原因**: `get_patterns` 方法返回布尔值，而调用方期望的是一个`pandas Series`或`DataFrame`。
- **文件**: `indicators/ad.py`.
- **方案**: 修改`indicators/ad.py`中的`get_patterns`方法，使其返回一个包含布尔值的`pandas Series`或`DataFrame`，而不是一个纯粹的布尔值。例如：`return pd.Series(pattern_conditions, index=data.index)`.

#### 3.2 RSI/MTM/ROC指标
- **问题**: 'dict' object has no attribute 'replace'.
- **原因**: 这些指标的`get_patterns`方法返回的是字典，而`auto_indicator_analyzer.py`期望的是`Series`或`DataFrame`。
- **文件**: `indicators/rsi.py`, `indicators/mtm.py`, `indicators/roc.py`, `analysis/buypoints/auto_indicator_analyzer.py`.
- **方案**: 统一`RSI`, `MTM`, `ROC` 指标中`get_patterns` 方法的返回格式，将其从`dict`修改为`pandas DataFrame`，确保列名和结构与其他指标一致，以满足分析器的要求。

### 4. 方法参数问题
#### 4.1 DIVERGENCE指标
- **问题**: `calculate() missing 1 required positional argument: 'indicator_name'`.
- **原因**: 调用`DivergenceIndicator.calculate()` 时未传递`indicator_name`参数。
- **文件**: `indicators/divergence.py` 及调用方代码.
- **方案**: 首先在`indicators/divergence.py` 中，将`calculate` 方法的签名修改为`def calculate(self, data: pd.DataFrame, indicator_name: str, **kwargs)`. 然后，找到调用此方法的地方（很可能在`analysis/buypoints/auto_indicator_analyzer.py`中），并传递所需的`indicator_name`参数。

#### 4.2 ZXMDIAGNOSTICS指标
- **问题**: 缺少`_analyze_volatility_health`方法。
- **原因**: 方法未实现。
- **文件**: `indicators/zxm/diagnostics.py`.
- **方案**: 在`indicators/zxm/diagnostics.py` 中，添加`_analyze_volatility_health` 方法的实现。如果具体逻辑未知，可以先实现一个返回默认值（例如 `'UNKNOWN'`)并记录警告日志的占位符方法。

### 5. 数据验证问题
#### 5.1 ZXMMARKETBREADTH指标
- **问题**: 指标需要一个多层索引的`DataFrame`。
- **原因**: 输入的数据是单层索引，不符合指标要求。
- **文件**: `indicators/zxm/market_breadth.py` 和其数据加载逻辑
- **方案**: 定位为`ZXMMarketBreadth`指标提供数据的代码。修改数据加载和预处理逻辑，以查询跨多个股票的数据，并使用`data.set_index(['date', 'code'])` 或类似方法，创建一个符合要求的多层索引`DataFrame`。

#### 5.2 TIME CYCLE ANALYSIS指标
- **问题**: 数据长度不足504个点。
- **原因**: 数据查询时没有获取足够历史数据。
- **文件**: `indicators/time_cycle_analysis.py` 和其数据加载逻辑
- **方案**: 在为该指标查询数据时，确保请求足够长的时间范围以获取至少504个数据点。同时，在`time_cycle_analysis.py` 内部添加一个数据长度检查，如果`len(data) < 504`，则记录一个明确的警告信息。

### 6. 工厂注册问题
#### 6.1 GENERIC_CONDITION
- **问题**: `Columns must be same length as key`.
- **原因**: 在`indicator factory`中动态构建`DataFrame`时，列的长度与索引的长度不匹配。
- **文件**: `indicators/factory.py`.
- **方案**: 调试`indicators/factory.py`中注册`GENERIC_CONDITION`类型指标的逻辑。重点检查创建`DataFrame`或添加新列的代码，确保所有数组、列表或`Series`在赋值给`DataFrame`时具有相同的长度。

#### 6.2 空白指标
- **问题**: 无法解析空表达式。
- **原因**: 公式指标的配置为空或无效。
- **文件**: `indicators/formula_indicators.py`.
- **方案**: 在`indicators/formula_indicators.py` 的公式解析逻辑开始处，增加一个校验。如果传入的公式字符串为空或`None`，则应直接返回（例如返回一个空的`DataFrame`），并记录一条错误日志，而不是尝试解析并导致程序崩溃。

## 三、实施清单

IMPLEMENTATION CHECKLIST:
1. 在`indicators/` 目录下找到`EnhancedTRIX` 和 `EnhancedKDJ` 的实现文件，修改其`__init__` 方法，确保调用父类构造函数并设置`indicator_type`属性。
2. 编辑`indicators/kc.py` 文件，删除对`'data.model'`模块的导入语句。
3. 编辑`indicators/dma.py` 文件，删除对`'data.model'`模块的导入语句。
4. 审查`indicators/kc.py` 和 `indicators/dma.py` 的`calculate`方法，确保它们在移除导入后仍能正常工作。
5. 编辑`utils/signal_utils.py` 文件，添加 `from scipy.signal import find_peaks`。
6. 在`utils/signal_utils.py` 文件中，定义一个封装`scipy.signal.find_peaks`的新函数`find_peaks`。
7. 定位项目中主要的K线数据查询函数（可能在`db/clickhouse_db.py`中）。
8. 修改该数据查询函数，确保返回的`DataFrame`中始终包含`'open', 'high', 'low', 'close', 'volume', 'turnover_rate'`列。
9. 编辑`indicators/bias.py` 文件，确保`calculate` 方法返回的`DataFrame`中包含名为`'bias'`的列。
10. 在`indicators/zxm/` 目录下，使用`grep`或类似工具搜索所有对`'capital'`的使用。
11. 逐个检查搜索结果，将使用`'capital'`的计算逻辑替换为基于`'volume'`或`'turnover_rate'`的等效逻辑。
12. 如果`'capital'`的使用无法被替换，则移除相关功能代码并记录一条警告日志。
13. 编辑`indicators/ad.py` 文件，修改`get_patterns` 方法，使其返回`pandas Series`或`DataFrame`。
14. 编辑`indicators/rsi.py` 文件，修改`get_patterns` 方法，使其返回`pandas DataFrame`而不是`dict`。
15. 编辑`indicators/mtm.py` 文件，修改`get_patterns` 方法，使其返回`pandas DataFrame`而不是`dict`。
16. 编辑`indicators/roc.py` 文件，修改`get_patterns` 方法，使其返回`pandas DataFrame`而不是`dict`。
17. 编辑`indicators/divergence.py` 文件，将`calculate` 方法的签名更改为包含`indicator_name: str`参数。
18. 找到调用`DivergenceIndicator.calculate()` 的代码（可能在`analysis/buypoints/auto_indicator_analyzer.py` 中），并传入`indicator_name`实参。
19. 编辑`indicators/zxm/diagnostics.py` 文件，添加一个`_analyze_volatility_health` 方法的占位符实现，该实现应记录警告并返回默认值。
20. 定位为`ZXMMarketBreadth` 指标提供数据的代码。
21. 修改该代码，使其查询多支股票的数据，并使用`set_index(['date', 'code'])` 创建多层索引。
22. 定位为`TimeCycleAnalysis` 指标提供数据的代码。
23. 修改该代码，确保查询的数据点不少于504个。
24. 编辑`indicators/time_cycle_analysis.py` 文件，添加数据长度检查，如果长度不足则记录警告。
25. 调试`indicators/factory.py` 中关于`GENERIC_CONDITION` 的代码，解决`'Columns must be same length as key'` 的错误。
26. 编辑`indicators/formula_indicators.py` 文件，在公式解析前添加对空或无效公式字符串的检查。 