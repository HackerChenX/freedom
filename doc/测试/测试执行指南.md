# 可配置选股系统测试执行指南

## 1. 概述

本指南为可配置选股系统的测试团队提供详细的测试执行流程、环境配置和最佳实践。按照本指南操作，可以确保测试过程的标准化、高效化和可重复性。

## 2. 测试环境准备

### 2.1 开发环境设置

1. **Python环境**
   ```bash
   # 创建虚拟环境
   python -m venv venv
   
   # 激活虚拟环境
   # Windows
   venv\Scripts\activate
   # MacOS/Linux
   source venv/bin/activate
   
   # 安装依赖
   pip install -r requirements.txt
   ```

2. **测试依赖安装**
   ```bash
   # 安装测试专用依赖
   pip install -r tests/requirements.txt
   ```

3. **环境变量配置**
   ```bash
   # 设置测试环境变量
   # Windows
   set STOCK_TEST_ENV=test
   set DB_TEST_HOST=localhost
   set DB_TEST_PORT=9000
   
   # MacOS/Linux
   export STOCK_TEST_ENV=test
   export DB_TEST_HOST=localhost
   export DB_TEST_PORT=9000
   ```

### 2.2 测试数据库配置

1. **模拟ClickHouse设置**
   ```bash
   # 启动测试数据库（使用Docker）
   docker run -d --name clickhouse-test -p 9000:9000 -p 8123:8123 yandex/clickhouse-server
   
   # 导入测试数据
   python tests/scripts/setup_test_db.py
   ```

2. **测试数据库验证**
   ```bash
   # 验证测试数据
   python tests/scripts/verify_test_data.py
   ```

### 2.3 测试数据准备

1. **生成测试数据**
   ```bash
   # 生成标准测试数据集
   python tests/scripts/generate_test_data.py
   ```

2. **验证测试数据**
   ```bash
   # 验证生成的数据
   python tests/scripts/validate_test_data.py
   ```

## 3. 测试执行流程

### 3.1 单元测试

1. **运行所有单元测试**
   ```bash
   python tests/run_tests.py --type unit
   ```

2. **运行特定模块测试**
   ```bash
   python tests/run_tests.py --type unit --module strategy
   ```

3. **运行单个测试文件**
   ```bash
   python -m unittest tests/unit/test_data_manager.py
   ```

4. **运行单个测试用例**
   ```bash
   python -m unittest tests.unit.test_data_manager.TestDataManager.test_get_klines
   ```

### 3.2 集成测试

1. **运行所有集成测试**
   ```bash
   python tests/run_tests.py --type integration
   ```

2. **运行特定流程测试**
   ```bash
   python tests/run_tests.py --type integration --module stock_selection
   ```

3. **运行端到端测试**
   ```bash
   python tests/run_tests.py --type integration --tags e2e
   ```

### 3.3 性能测试

1. **运行所有性能测试**
   ```bash
   python tests/run_tests.py --type performance
   ```

2. **运行特定性能测试**
   ```bash
   python tests/run_tests.py --type performance --module strategy_executor
   ```

3. **使用特定配置运行性能测试**
   ```bash
   python tests/run_tests.py --type performance --config tests/performance/configs/high_load.json
   ```

### 3.4 测试覆盖率分析

1. **生成覆盖率报告**
   ```bash
   python tests/run_tests.py --coverage
   ```

2. **查看HTML覆盖率报告**
   ```bash
   # 报告位置: htmlcov/index.html
   open htmlcov/index.html
   ```

## 4. 测试数据管理

### 4.1 测试数据工厂使用

1. **创建测试股票列表**
   ```python
   from tests.test_data_factory import TestDataFactory
   
   # 创建100支测试股票
   stocks = TestDataFactory.create_stock_list(count=100)
   ```

2. **创建测试K线数据**
   ```python
   from tests.test_data_factory import TestDataFactory
   
   # 创建2022年全年日线数据
   klines = TestDataFactory.create_kline_data(
       stock_code="000001",
       start_date="2022-01-01",
       end_date="2022-12-31",
       period="DAILY"
   )
   ```

3. **创建测试策略配置**
   ```python
   from tests.test_data_factory import TestDataFactory
   
   # 创建测试策略
   strategy_config = TestDataFactory.create_strategy_config(
       name="测试策略",
       indicators=["MA_CROSS", "RSI_OVERSOLD"],
       logic="AND"
   )
   ```

### 4.2 模拟组件使用

1. **使用模拟数据库**
   ```python
   from tests.mocks.db_mock import MockClickHouseDB
   
   # 创建模拟数据库
   mock_db = MockClickHouseDB()
   
   # 配置模拟响应
   mock_db.add_query_response(
       query_pattern="SELECT.*FROM stock_list.*",
       response=[{"stock_code": "000001", "stock_name": "测试股票"}]
   )
   ```

2. **使用模拟数据管理器**
   ```python
   from tests.mocks.db_mock import MockDataManager
   
   # 创建模拟数据管理器
   mock_data_manager = MockDataManager()
   
   # 配置模拟响应
   mock_data_manager.set_stock_list([
       {"stock_code": "000001", "stock_name": "测试股票1"},
       {"stock_code": "000002", "stock_name": "测试股票2"}
   ])
   ```

## 5. 测试报告生成

### 5.1 标准报告生成

1. **生成HTML测试报告**
   ```bash
   python tests/run_tests.py --report html
   ```

2. **生成XML测试报告**
   ```bash
   python tests/run_tests.py --report xml
   ```

3. **生成JSON测试报告**
   ```bash
   python tests/run_tests.py --report json
   ```

### 5.2 性能测试报告

1. **生成性能测试报告**
   ```bash
   python tests/run_tests.py --type performance --report performance
   ```

2. **生成性能对比报告**
   ```bash
   python tests/scripts/compare_performance.py --baseline results/baseline.json --current results/current.json
   ```

## 6. 常见问题与解决方案

### 6.1 环境问题

| 问题 | 解决方案 |
|------|---------|
| 依赖安装失败 | 检查Python版本兼容性，尝试使用`pip install --upgrade pip`更新pip |
| 测试数据库连接失败 | 验证数据库配置和连接信息，检查防火墙设置 |
| 路径问题 | 确保在项目根目录下执行命令，或使用绝对路径 |

### 6.2 测试执行问题

| 问题 | 解决方案 |
|------|---------|
| 测试超时 | 增加测试超时配置，检查测试环境资源 |
| 测试结果不一致 | 清理测试环境，重置测试数据，检查随机因素 |
| 测试资源冲突 | 使用唯一的测试资源名称，避免并行测试冲突 |

### 6.3 报告生成问题

| 问题 | 解决方案 |
|------|---------|
| 报告生成失败 | 检查输出目录权限，确保所有测试结果收集完整 |
| 覆盖率数据不准确 | 确保使用正确的源代码路径，排除不需要覆盖的文件 |
| 报告格式问题 | 更新报告生成工具，检查模板文件完整性 |

## 7. 测试最佳实践

### 7.1 单元测试最佳实践

1. **测试命名规范**
   - 测试函数名应明确表示被测功能和测试场景
   - 示例：`test_get_klines_with_valid_params`、`test_get_klines_with_invalid_date`

2. **测试结构规范**
   - 遵循"准备-执行-验证"（Arrange-Act-Assert）模式
   - 每个测试只测试一个功能点
   - 避免测试之间的依赖

3. **断言使用规范**
   - 使用明确的断言方法（assertEqual、assertTrue等）
   - 提供有意义的失败消息
   - 验证所有关键结果和状态

### 7.2 集成测试最佳实践

1. **测试隔离**
   - 每个测试应在隔离环境中运行
   - 测试开始前准备环境，结束后清理环境
   - 使用固定的测试数据，避免环境依赖

2. **端到端测试策略**
   - 测试关键业务流程的完整路径
   - 验证各组件协同工作的结果
   - 模拟真实用户操作和场景

3. **资源管理**
   - 合理控制测试资源使用
   - 使用tearDown方法释放资源
   - 避免资源泄漏影响其他测试

### 7.3 性能测试最佳实践

1. **基准设置**
   - 建立明确的性能基准线
   - 记录基准测试的环境和配置
   - 定期更新基准以适应系统变化

2. **测试稳定性**
   - 多次运行测试取平均值
   - 排除异常值和干扰因素
   - 在标准化环境中执行测试

3. **性能监控**
   - 监控CPU、内存、磁盘I/O等资源使用
   - 记录测试期间的系统状态
   - 分析性能瓶颈和限制因素

## 8. 持续集成集成

### 8.1 GitHub Actions配置

1. **创建工作流配置文件**
   - 创建`.github/workflows/tests.yml`文件
   - 配置测试触发条件和环境设置
   - 设置测试执行步骤和结果收集

2. **示例配置**
   ```yaml
   name: Run Tests
   
   on:
     push:
       branches: [ main, develop ]
     pull_request:
       branches: [ main, develop ]
   
   jobs:
     test:
       runs-on: ubuntu-latest
       
       services:
         clickhouse:
           image: yandex/clickhouse-server
           ports:
             - 9000:9000
             - 8123:8123
       
       steps:
       - uses: actions/checkout@v2
       - name: Set up Python
         uses: actions/setup-python@v2
         with:
           python-version: '3.8'
       - name: Install dependencies
         run: |
           python -m pip install --upgrade pip
           pip install -r requirements.txt
           pip install -r tests/requirements.txt
       - name: Setup test database
         run: python tests/scripts/setup_test_db.py
       - name: Run tests
         run: python tests/run_tests.py --coverage --report xml
       - name: Upload coverage report
         uses: codecov/codecov-action@v1
   ```

### 8.2 Jenkins配置

1. **创建Jenkinsfile**
   - 在项目根目录创建`Jenkinsfile`
   - 配置测试流水线和环境设置
   - 设置测试结果收集和报告生成

2. **示例配置**
   ```groovy
   pipeline {
       agent {
           docker {
               image 'python:3.8'
           }
       }
       stages {
           stage('Setup') {
               steps {
                   sh 'pip install -r requirements.txt'
                   sh 'pip install -r tests/requirements.txt'
               }
           }
           stage('Test') {
               steps {
                   sh 'python tests/run_tests.py --coverage --report xml'
               }
               post {
                   always {
                       junit 'test-reports/*.xml'
                       publishHTML([
                           allowMissing: false,
                           alwaysLinkToLastBuild: true,
                           keepAll: true,
                           reportDir: 'htmlcov',
                           reportFiles: 'index.html',
                           reportName: 'Coverage Report'
                       ])
                   }
               }
           }
       }
   }
   ```

## 9. 测试执行清单

### 9.1 测试前清单

- [ ] 环境配置验证
- [ ] 测试数据准备完成
- [ ] 测试依赖安装完成
- [ ] 测试数据库配置验证
- [ ] 测试执行权限确认
- [ ] 测试脚本最新版本确认
- [ ] 测试环境资源充足

### 9.2 测试执行清单

- [ ] 运行单元测试并验证通过
- [ ] 运行集成测试并验证通过
- [ ] 运行性能测试并验证符合基准
- [ ] 生成覆盖率报告并检查覆盖率
- [ ] 检查测试日志中的警告和错误
- [ ] 验证测试数据清理和资源释放

### 9.3 测试后清单

- [ ] 收集并整理测试报告
- [ ] 分析测试结果和问题
- [ ] 记录发现的问题到缺陷跟踪系统
- [ ] 整理测试数据和日志
- [ ] 清理测试环境
- [ ] 更新测试文档和知识库

## 10. 附录

### 10.1 测试命令参考

| 命令 | 描述 |
|------|------|
| `python tests/run_tests.py --help` | 显示帮助信息 |
| `python tests/run_tests.py --list` | 列出所有可用测试 |
| `python tests/run_tests.py --type unit` | 运行单元测试 |
| `python tests/run_tests.py --type integration` | 运行集成测试 |
| `python tests/run_tests.py --type performance` | 运行性能测试 |
| `python tests/run_tests.py --coverage` | 生成覆盖率报告 |
| `python tests/run_tests.py --report html` | 生成HTML报告 |
| `python tests/run_tests.py --verbose` | 显示详细测试信息 |
| `python tests/run_tests.py --quiet` | 只显示测试结果摘要 |

### 10.2 常用环境变量

| 环境变量 | 描述 | 默认值 |
|---------|------|--------|
| `STOCK_TEST_ENV` | 测试环境标识 | `test` |
| `DB_TEST_HOST` | 测试数据库主机 | `localhost` |
| `DB_TEST_PORT` | 测试数据库端口 | `9000` |
| `DB_TEST_USER` | 测试数据库用户 | `default` |
| `DB_TEST_PASSWORD` | 测试数据库密码 | `` |
| `TEST_DATA_PATH` | 测试数据路径 | `tests/data` |
| `TEST_RESULT_PATH` | 测试结果路径 | `tests/results` |
| `TEST_TIMEOUT` | 测试超时时间(秒) | `60` |
| `TEST_PARALLEL` | 并行测试进程数 | `4` |

### 10.3 有用的资源

1. **文档链接**
   - 项目文档: `doc/`目录
   - API文档: `doc/api/`目录
   - 架构文档: `doc/系统设计/`目录

2. **测试相关资源**
   - 测试数据样本: `tests/data/samples/`目录
   - 测试脚本: `tests/scripts/`目录
   - 测试工具: `tests/tools/`目录

3. **问题报告**
   - 问题跟踪系统: [项目Issue跟踪器](http://issue-tracker.example.com)
   - 测试报告存档: `doc/review/`目录 