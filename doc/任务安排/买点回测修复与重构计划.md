# 买点回测修复与重构计划

## 1. 概述

本计划旨在解决买点回测分析中存在的**指标形态识别错误**和**性能不佳**的问题。计划遵循"混合与渐进式重构"策略，分阶段实施，确保在最低风险下快速修复核心业务逻辑，并为系统未来的可维护性和性能提升打下坚实基础。

## 2. 任务优先级与拆解

### P0：紧急修复 - 保证业务正确性（立即执行）

此阶段的目标是立刻修复 `AutoIndicatorAnalyzer` 的逻辑缺陷，确保即使面对设计不佳的指标，分析结果也是正确的。

1.  **修改 `AutoIndicatorAnalyzer`**
    *   **文件**: `analysis/buypoints/auto_indicator_analyzer.py`
    *   **方法**: `_analyze_indicator_patterns`
    *   **具体操作**:
        1.  定位到 `elif isinstance(patterns_result, list):` 分支。这是处理旧格式指标返回值的核心区域。
        2.  **获取买点日期**: 在该分支内，通过 `target_idx` 从传入的 `indicator_df` 中获取目标日期：`target_date = indicator_df.index[target_idx]`。
        3.  **重写过滤逻辑**: 完全替换现有逻辑。创建一个空的 `hit_patterns` 列表，然后遍历 `patterns_result` 中的每一个形态字典 `pattern_dict`。
            *   实现一个健壮的日期检查函数，该函数按以下优先顺序查找日期键：`date`, `end_date`, `start_date`。
            *   判断 `target_date` 是否落在形态的有效期内（对于`start_date`和`end_date`，判断是否`start_date <= target_date <= end_date`；对于单个`date`，判断是否相等）。
            *   只有当日期匹配时，才将该形态加入 `hit_patterns`。
        4.  **添加弃用警告**: 在该分支的逻辑开始处，添加一条警告日志，以便在运行时暴露使用旧模式的指标：`logging.warning(f"指标 {indicator.name} 正在使用已弃用的列表格式返回形态，影响性能且不规范。请计划将其重构为返回布尔型DataFrame的新标准。")`

### P1：架构基础建设 - 明确新规范（高优先级）

此阶段旨在建立和文档化新的开发标准，防止未来出现类似问题。

1.  **更新 `BaseIndicator` 文档**
    *   **文件**: `indicators/base_indicator.py`
    *   **操作**:
        *   为 `get_patterns` 和 `identify_patterns` 方法添加或更新文档字符串。
        *   在文档中明确指出，**推荐的、标准的返回格式是 `pandas.DataFrame`**，其 `index` 为日期，`columns` 为形态ID，值为布尔值。
        *   明确说明 `List[Dict]` 格式是**已弃用 (deprecated)** 的，仅为向后兼容而保留。

2.  **创建《指标开发规范》文档**
    *   **文件**: `doc/系统设计/指标开发规范.md` (新文件)
    *   **内容**:
        *   详细描述新的指标开发标准。
        *   提供一个符合新标准的指标（如KDJ）的实现代码，作为"黄金范例"。
        *   解释新旧两种模式的优劣对比，从性能、可维护性、代码清晰度等角度强调新标准的优势。

### P2：技术债识别与跟踪（中优先级）

此阶段的目标是全面识别并记录需要重构的模块。

1.  **创建技术债清单**
    *   **文件**: `doc/任务安排/技术债-指标重构清单.md` (新文件)
    *   **内容**:
        *   运行一个脚本或手动检查所有 `indicators/` 目录下的文件。
        *   识别所有 `get_patterns` 或 `identify_patterns` 方法返回 `List` 或 `List[Dict]` 的指标。
        *   将所有不符合新规范的指标以清单的形式记录下来。已知需要重构的指标包括：`RSI`, `MACD`, `BOLL` 等。

### P3：渐进式重构 - 偿还技术债（长期任务）

此阶段是具体的重构执行，可以根据开发资源和迭代计划分批进行。

1.  **逐个重构指标**
    *   **目标**: 按照 `技术债-指标重构清单.md` 的列表，逐一重构指标。
    *   **操作 (以 `RSI` 为例)**:
        1.  修改 `indicators/rsi.py`。
        2.  重写 `get_patterns` 方法。
        3.  消除内部的 `for` 循环，改用向量化的 `pandas` 操作来识别所有形态（如超买、超卖、背离）。
        4.  确保方法最终返回一个符合新规范的、包含所有形态列的布尔型 `pandas.DataFrame`。
    *   **验证**: 每次重构后，需运行相关单元测试，并与修复前的版本进行对比测试，确保新实现在逻辑上的一致性和性能上的提升。

---

## 3. 实施清单

为了确保精确执行，以下是具体的原子操作清单。

IMPLEMENTATION CHECKLIST:
1. 在 `doc/任务安排/` 目录下创建新文件 `买点回测修复与重构计划.md` 并写入上述全部计划内容。
2. 在 `analysis/buypoints/auto_indicator_analyzer.py` 的 `_analyze_indicator_patterns` 方法中，定位到处理列表返回值的 `elif` 分支。
3. 在该分支内，实现逻辑以从 `indicator_df` 和 `target_idx` 提取 `target_date`。
4. 在该分支内，重写过滤逻辑，使其能根据 `target_date` 和形态字典中的日期信息（`date`, `start_date`, `end_date`）正确过滤形态。
5. 在该分支的开头，添加一条 `logging.warning`，用于在日志中标记出使用了已弃用格式的指标。
6. 在 `indicators/base_indicator.py` 文件中，更新 `get_patterns` 和 `identify_patterns` 方法的文档字符串，明确新的返回标准（布尔型DataFrame）并将旧格式标记为已弃用。
7. 在 `doc/系统设计/` 目录下创建新文件 `指标开发规范.md`。
8. 在 `指标开发规范.md` 中，详细编写新的指标开发指南，包含代码范例和新旧模式对比。
9. 在 `doc/任务安排/` 目录下创建新文件 `技术债-指标重构清单.md`。
10. 在 `技术债-指标重构清单.md` 中，通过检查代码，列出所有目前不符合新返回标准的指标。
11. 按照技术债清单，选择第一个指标（如 `RSI`）开始重构，使其 `get_patterns` 方法返回布尔型 DataFrame。
12. 为重构后的 `RSI` 指标编写或更新单元测试，以验证其正确性。 