# 回测分析与选股公式使用指南

## 一、工具介绍

本套工具提供了从股票回测分析到通达信选股公式生成的完整流程，帮助用户基于历史数据发现有效的买点特征，并将这些特征转化为可直接使用的通达信选股公式。主要功能包括：

1. **回测分析**：分析指定股票在特定日期的多周期技术指标表现
2. **共性特征提取**：自动提取多个买点的共性技术特征
3. **选股公式生成**：基于回测结果自动生成通达信选股公式
4. **公式文件导出**：将公式导出为单独文件，便于导入通达信

## 二、回测分析流程

### 1. 准备买点数据

回测分析需要一个包含股票代码、日期和买点类型的CSV文件，格式如下：

```
code,date,pattern_type
300005,20250424,MA20支撑
300005,20250425,KDJ超卖回调
```

可以将此类文件保存在项目的`examples`目录下。

### 2. 执行回测分析

使用以下命令执行回测分析：

```bash
python bin/backtest.py --csv examples/buypoints.csv --days-before 30 --days-after 10
```

参数说明：
- `--csv`：指定买点数据文件路径
- `--days-before`：分析买点前N天数据（默认30天）
- `--days-after`：分析买点后N天数据（默认10天）

### 3. 分析结果查看

回测完成后，会在`data/result/回测结果/`目录下生成分析报告，文件名格式为`综合回测分析_日期_时间.md`。报告包含以下内容：

- 各周期共性特征
- 个股分析详情
- 选股策略建议

## 三、生成通达信选股公式

### 1. 创建回测分析报告

针对特定股票的回测分析，建议创建一个专门的分析报告，包含回测结果和基于分析结果设计的通达信选股公式。可以参考`doc/探路者(300005)回测分析与选股公式.md`的格式。

### 2. 提取通达信公式

使用以下命令从分析报告中提取通达信公式：

```bash
python bin/extract_formula.py -f doc/回测分析报告.md
```

参数说明：
- `-f, --file`：指定回测分析报告文件
- `-o, --output`：指定公式导出目录（默认为`data/result/通达信公式/`）
- `-a, --all`：处理所有回测分析报告文件

### 3. 导入通达信软件

生成的公式文件保存在`data/result/通达信公式/`目录下，可以通过以下步骤导入通达信软件：

1. 打开通达信软件
2. 点击"选股"功能
3. 点击"指标选股"
4. 点击"导入公式"
5. 选择生成的公式文件（*.txt）
6. 根据公式说明调整参数
7. 点击"选股"执行

## 四、实战应用建议

### 1. 多周期共振选股

对于更可靠的选股结果，建议使用"多周期共振买点选股公式"，该公式综合考虑日线和分钟线指标，能有效过滤虚假信号。使用步骤：

1. 先在日线图表中使用公式筛选出符合条件的股票
2. 对筛选结果进行分钟图表确认
3. 重点关注指标共振的股票

### 2. 分钟级短线操作

对于日内交易，建议使用"分钟级共振买点选股公式"，该公式适用于15/30/60分钟图表，使用步骤：

1. 在通达信分钟周期图表中应用该公式
2. 选择KDJ或RSI超卖且有支撑的股票
3. 控制仓位，设置严格止损

### 3. 超跌反弹捕捉

对于超跌股反弹机会，建议使用"日线KDJ超卖回调买点选股公式"，使用步骤：

1. 在日线图表中应用该公式
2. 重点关注KDJ指标已经开始回升的股票
3. 结合成交量放大确认

## 五、常见问题

### 1. 回测数据不足

Q: 回测时提示"DataFrame至少需要XX行数据，但只有YY行"怎么办？
A: 增加`--days-before`参数值，确保有足够的历史数据进行技术指标计算。

### 2. 公式参数调整

Q: 如何调整公式参数以适应不同市场环境？
A: 在通达信中导入公式后，可以根据实际情况调整以下参数：
   - KDJ超卖阈值（如K<20可调整为K<25）
   - 量能放大倍数（如V/MA(V,5)>1.2可调整为>1.5）
   - MACD底背离判断期数（如COUNT(MACD<0,10)>=7可调整为>=5）

### 3. 公式导出失败

Q: 运行`extract_formula.py`提示"未从文件中提取到任何公式"怎么办？
A: 确保分析报告中的公式格式正确，公式需要包含在```（三个反引号）代码块中，且公式名称应匹配"###"标题后的内容。

## 六、进阶应用

### 1. 自定义公式构建

基于回测分析的结果，您可以修改已有公式或创建新的公式。公式结构通常包括：

1. 指标定义部分（如KDJ、MACD等计算）
2. 条件判断部分（如超卖、支撑等特征判断）
3. 信号合成部分（多个条件的组合）

### 2. 多股票批量回测

对于需要分析多只股票的情况，建议创建一个包含多只股票的CSV文件，格式同上，然后使用回测脚本进行批量分析，这有助于发现更普遍的选股规律。

### 3. 策略性能评估

对于生成的选股公式，可以使用通达信的回测功能评估其历史表现，关注以下指标：

- 胜率（成功率）
- 平均收益
- 最大回撤
- 夏普比率

## 七、总结

本工具集提供了从回测分析到选股公式生成的完整解决方案，帮助用户系统性地研究买点特征并将研究成果转化为实用的选股工具。建议用户先从少量股票开始，逐步积累经验，不断优化选股参数和策略，形成适合自己的交易系统。 