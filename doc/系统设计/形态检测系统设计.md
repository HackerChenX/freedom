# 形态检测系统设计

## 概述

形态检测系统是股票分析系统的重要组成部分，旨在检测各种技术指标形成的特定形态，并为交易策略和选股提供决策依据。该系统使用统一的注册表管理所有形态，并允许各个指标独立定义和注册自己特有的形态检测方法。

## 系统架构

### 核心组件

1. **PatternRegistry**：形态注册表，单例模式，负责管理所有已注册的形态。
2. **BaseIndicator**：所有技术指标的基类，提供形态检测和注册的通用方法。
3. **具体指标实现**：如BOLL, KDJ, DMI等，各自实现特有的形态检测方法。

### 关键枚举

1. **PatternType**：形态类型，如上升、下降、中性、反转等。
2. **PatternStrength**：形态强度，如强、中、弱。

## 形态注册机制

### 注册流程

1. 各指标在初始化或特定方法调用时，注册自己支持的形态到PatternRegistry。
2. 注册时提供形态ID、显示名称、描述、指标ID、形态类型、默认强度、得分影响等信息。
3. 同时提供检测函数的引用，用于后续检测该形态是否出现。

### 注册代码示例

```python
registry = PatternRegistry()
registry.register(
    pattern_id="BOLL_PRICE_TOUCH_UPPER",
    display_name="布林带价格触及上轨",
    description="价格触及上轨但未突破，可能是阻力位",
    indicator_id="BOLL",
    pattern_type=PatternType.RESISTANCE,
    default_strength=PatternStrength.MEDIUM,
    score_impact=-10.0,
    detection_function=self._detect_price_touch_upper
)
```

## 形态检测机制

### 检测流程

1. 获取需要检测的数据，如最近N个交易日的K线数据。
2. 通过PatternRegistry获取所需指标的所有已注册形态。
3. 对每个形态，调用其检测函数，传入当前数据。
4. 检测函数返回布尔值，表示是否检测到该形态。
5. 汇总所有检测到的形态，可用于后续交易决策或选股。

### 检测函数示例

```python
def _detect_price_touch_upper(self, data: pd.DataFrame) -> bool:
    """检测价格触及上轨形态"""
    if not self.has_result():
        return False
    
    # 确保数据量足够
    if len(data) < 3:
        return False
    
    # 获取最近的价格和布林带数据
    recent_close = data['close'].iloc[-3:]
    recent_upper = self._result['upper'].iloc[-3:]
    
    # 检测价格是否接近上轨但未突破
    touch_upper = (
        abs(recent_close.iloc[-1] - recent_upper.iloc[-1]) / recent_upper.iloc[-1] < 0.005 and
        recent_close.iloc[-1] < recent_upper.iloc[-1]
    )
    
    return touch_upper
```

## 形态查询机制

### 查询方法

1. **按指标查询**：获取特定指标的所有已注册形态。
2. **按形态ID查询**：获取特定形态的详细信息。
3. **按形态类型查询**：获取所有属于特定类型的形态。
4. **获取所有形态**：获取系统中所有已注册的形态。

### 查询代码示例

```python
# 获取特定指标的所有形态
kdj_patterns = registry.get_patterns_by_indicator("KDJ")

# 获取特定形态的详细信息
pattern_info = registry.get_pattern("KDJ_GOLDEN_CROSS")

# 获取所有属于特定类型的形态
bullish_patterns = registry.get_patterns_by_type(PatternType.BULLISH)
```

## 已实现的指标和形态

### BOLL指标形态
- **BOLL_PRICE_TOUCH_UPPER**：价格触及上轨
- **BOLL_PRICE_TOUCH_LOWER**：价格触及下轨
- **BOLL_PRICE_BREAK_UPPER**：价格突破上轨
- **BOLL_PRICE_BREAK_LOWER**：价格突破下轨
- **BOLL_BANDWIDTH_EXPANDING**：带宽扩大
- **BOLL_BANDWIDTH_CONTRACTING**：带宽收缩
- **BOLL_PRICE_CROSS_UP_MIDDLE**：价格上穿中轨
- **BOLL_PRICE_CROSS_DOWN_MIDDLE**：价格下穿中轨
- **BOLL_PARALLEL_BANDS**：布林带平行
- **BOLL_W_BOTTOM**：W底形态
- **BOLL_M_TOP**：M顶形态

### KDJ指标形态
- **KDJ_GOLDEN_CROSS**：金叉形态
- **KDJ_DEATH_CROSS**：死叉形态
- **KDJ_OVERBOUGHT**：超买形态
- **KDJ_OVERSOLD**：超卖形态
- **KDJ_BULLISH_DIVERGENCE**：看涨背离
- **KDJ_BEARISH_DIVERGENCE**：看跌背离

### DMI指标形态
- **DMI_CROSSOVER**：DI交叉形态
- **DMI_ADX_RISING**：ADX上升形态

### TRIX指标形态
- **TRIX_ZERO_CROSS**：零轴穿越
- **TRIX_DIVERGENCE**：背离形态

### WMA指标形态
- **WMA_CONVERGENCE**：均线收敛形态
- **WMA_DIVERGENCE**：均线发散形态

### VOL指标形态
- **VOL_BREAKOUT**：成交量放量突破
- **VOL_PULLBACK**：成交量缩量回调
- **VOL_PRICE_SYNC**：量价同步
- **VOL_PRICE_DIVERGENCE**：量价背离
- **VOL_EXHAUSTION**：成交量耗竭
- **VOL_GRADUAL**：成交量渐变
- **VOL_ABNORMAL**：成交量异常
- **VOL_PLATFORM**：成交量平台
- **VOL_ACCUMULATION**：成交量积累

### BIAS指标形态
- **BIAS_EXTREME**：乖离率极值
- **BIAS_DIVERGENCE**：乖离率背离

### PlatformBreakout指标形态
- **PLATFORM_BREAKOUT**：平台突破
- **FALSE_BREAKOUT**：假突破
- **STRONG_BREAKOUT**：强势突破
- **CONSOLIDATION**：整理形态
- **PLATFORM_RETEST**：平台回测

## 系统扩展性

本系统具有良好的扩展性，可以方便地添加新的指标和形态：

1. **添加新指标**：创建新的指标类，继承自BaseIndicator，实现必要的计算方法。
2. **添加新形态**：在指标类中实现形态检测方法，并在适当的时机注册到PatternRegistry。
3. **自定义形态类型**：可以扩展PatternType枚举，添加新的形态类型。

## 使用示例

```python
# 创建BOLL指标实例
boll = BOLL()

# 计算指标
boll.calculate(data)

# 注册形态
boll._register_boll_patterns()

# 获取该指标注册的所有形态
patterns = boll.get_registered_patterns()

# 检测最近的数据是否有形态
detected_patterns = []
for pattern_id, pattern_info in patterns.items():
    detection_func = pattern_info.get('detection_func')
    if detection_func and callable(detection_func):
        is_detected = detection_func(latest_data)
        if is_detected:
            detected_patterns.append({
                'pattern_id': pattern_id,
                'display_name': pattern_info.get('display_name', ''),
                'score_impact': pattern_info.get('score_impact', 0)
            })

# 输出检测结果
for p in detected_patterns:
    print(f"{p['display_name']} (ID: {p['pattern_id']}, 得分影响: {p['score_impact']})")
```

## 注意事项

1. 形态检测方法应该严谨地处理各种边缘情况，如数据不足、必要列缺失等。
2. 避免形态ID重复，建议使用"{指标ID}_{形态名称}"的格式。
3. 检测函数应该是指标实例的方法，以便访问指标的计算结果。
4. 避免在检测函数中进行复杂计算，应尽量利用指标已计算的结果。
5. 处理好异常情况，如必要数据列缺失、数据长度不足等，确保系统稳定性。 