# 指标开发规范

## 1. 概述

为了确保系统的稳定性、可维护性和高性能，所有新的技术指标开发及现有指标的重构都必须遵循本规范。本规范的核心是**统一形态识别的返回标准**，以消除逻辑混乱和性能瓶颈。

## 2. 核心原则：统一返回标准

所有指标的形态识别方法 (`get_patterns` 或 `identify_patterns`) **必须返回 `pandas.DataFrame`** 格式。

### 标准返回格式详解

*   **类型**: `pandas.DataFrame`
*   **索引 (Index)**: 必须是日期时间索引 (`DatetimeIndex`)，与输入的K线数据保持一致。
*   **列 (Columns)**: 每个列代表一种技术形态的ID（例如 `GOLDEN_CROSS`, `TOP_DIVERGENCE`）。
*   **值 (Values)**: 必须是布尔值 (`True` / `False`)。`True` 表示在当天该形态成立。

### 为什么必须使用 `DataFrame`?

| 特性 | 标准 `DataFrame` 模式 (推荐) | 已弃用的 `List[Dict]` 模式 |
| :--- | :--- | :--- |
| **性能** | **极高**。使用Pandas向量化操作，避免Python循环，计算速度快。 | **极低**。通常需要用Python循环遍历全部历史数据，性能差。 |
| **数据传输** | **高效**。DataFrame是紧凑的二进制格式，内存占用和传输开销小。 | **低效**。返回巨大的字典列表，可能包含大量冗余信息，消耗大量内存。 |
| **上层处理** | **简单、可靠**。分析器只需 `iloc[target_idx]` 即可精确获取目标日形态。 | **复杂、脆弱**。分析器需要实现复杂的日期匹配逻辑，且依赖字典中不统一的日期键。 |
| **代码清晰度** | **高**。逻辑统一，易于理解和维护。 | **低**。每个指标实现方式不同，代码混乱，难以维护。 |
| **可扩展性** | **好**。新增形态只需增加一个布尔列，符合规范。 | **差**。形态的定义和返回格式五花八门，难以扩展。 |

---

## 3. "黄金范例": KDJ指标的正确实现

以下是一个符合新规范的指标实现示例。所有新指标都应以此为模板。

```python
import pandas as pd
from indicators.base_indicator import BaseIndicator

class KDJ(BaseIndicator):
    name = "KDJ"
    # ... 其他属性 ...

    def calculate(self, data: pd.DataFrame) -> pd.DataFrame:
        # 高效的向量化计算K, D, J值
        # ... (计算逻辑)
        indicator_df = pd.DataFrame(index=data.index)
        indicator_df['K'] = ...
        indicator_df['D'] = ...
        indicator_df['J'] = ...
        return indicator_df

    def get_patterns(self, indicator_df: pd.DataFrame) -> pd.DataFrame:
        """
        识别所有KDJ形态，并以标准的布尔型DataFrame格式返回。
        """
        patterns_df = pd.DataFrame(index=indicator_df.index)

        # 1. 金叉/死叉 (向量化实现)
        k = indicator_df['K']
        d = indicator_df['D']
        patterns_df['GOLDEN_CROSS'] = self.crossover(k, d)
        patterns_df['DEATH_CROSS'] = self.crossunder(k, d)

        # 2. 超买/超卖 (向量化实现)
        patterns_df['OVERBOUGHT'] = (k > 80) & (d > 80)
        patterns_df['OVERSOLD'] = (k < 20) & (d < 20)
        
        # 3. J值反转 (向量化实现)
        j = indicator_df['J']
        patterns_df['J_REVERSAL_UP'] = self.crossover(j, 0)
        patterns_df['J_REVERSAL_DOWN'] = self.crossunder(j, 100)

        # ... 其他形态 ...

        return patterns_df
```

### 关键点检查清单

- [ ] `get_patterns` 方法的返回值类型注解是 `pd.DataFrame`。
- [ ] 方法内部完全使用Pandas向量化操作（如 `crossover`, `&`, `|`），**严禁使用 `for` 循环遍历行**。
- [ ] 返回的DataFrame的索引与输入的 `indicator_df` 索引完全一致。
- [ ] 返回的DataFrame的所有值都是布尔类型 (`True`/`False`)。

---

## 4. 如何重构旧指标

对于 `技术债-指标重构清单.md` 中列出的旧指标，重构时应遵循以下步骤：

1.  **备份旧逻辑**: 在开始修改前，将旧的 `get_patterns` 方法复制并注释掉，以备参考。
2.  **创建空的 `patterns_df`**: `patterns_df = pd.DataFrame(index=indicator_df.index)`。
3.  **逐个形态进行向量化**:
    *   分析旧的 `for` 循环逻辑。
    *   使用Pandas提供的函数和布尔索引，将循环判断条件改写为向量化操作。
    *   将结果（一个布尔型的 `pd.Series`）赋给 `patterns_df` 的一个新列。
4.  **移除旧代码**: 重构完成后，彻底删除被注释掉的旧代码。
5.  **运行测试**: 确保重构后的逻辑与旧逻辑在关键日期点的判断结果一致。

通过遵循本规范，我们将逐步统一系统架构，提升整体性能和代码质量。 