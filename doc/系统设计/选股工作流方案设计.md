# 选股工作流详细方案设计

## 一、概述
本方案基于《选股工作流实现任务拆解》中的任务表格，结合现有系统模块（`analysis/buypoints/`、`db/clickhouse_db.py`、`indicators/`等），聚焦未完成/需优化的任务，避免重复实现已有功能。

---

## 二、数据获取与处理层（已部分实现）
### 目标
完善批量数据处理能力，保障多周期数据的完整性与一致性。

### 现有系统依赖
- 多周期数据查询：复用`db/clickhouse_db.py`的`query_kline_data`方法（已支持15min、日线、周线、月线查询）。
- 周期转换：复用`utils/period_manager.py`的`convert_period`函数（基础实现，需优化性能）。

### 实现步骤
#### 1.1 CSV输入处理模块（部分实现）

## 三、技术指标列表及优化方案

### 3.1 现有技术指标列表

#### 趋势类指标
- MA：移动平均线
- EMA：指数移动平均线
- WMA：加权移动平均线
- MACD：平滑异同移动平均线
- BOLL：布林带
- SAR：抛物线转向
- DMI：趋向指标
- BIAS：均线多空指标

#### 震荡类指标
- RSI：相对强弱指标
- KDJ：随机指标
- WR：威廉指标
- CCI：顺势指标
- MTM：动量指标
- ROC：变动率
- STOCHRSI：随机相对强弱指标

#### 量能类指标
- VOL：成交量
- OBV：能量潮
- VOSC：成交量变异率
- MFI：资金流向指标
- VR：成交量指标
- PVT：价量趋势指标
- EMV：指数平均数指标
- VIX：恐慌指数

#### ZXM评分指标
- ZXM弹性评分指标（ZXM_ELASTICITY_SCORE）
- ZXM买点评分指标（ZXM_BUYPOINT_SCORE）

### 3.2 各指标优化方案

#### 趋势类指标优化
- **MA/EMA/WMA**：优化计算逻辑，采用Pandas向量化`rolling`方法替代循环，提升计算效率（计算耗时降低约40%）；增加多周期参数支持（如5日/10日/20日均线同时计算），支持通过配置文件动态指定周期组合（配置示例：`periods: [5, 10, 20]`）。
- **MACD**：引入动态周期参数（根据市场波动率调整快慢周期，公式：`fast_period = 12 * (1 + volatility_ratio*0.5)`）；优化信号生成逻辑，增加二次交叉确认机制（金叉后3日内DIF未跌破DEA方确认有效）。
- **BOLL**：扩展带宽计算方式（支持标准差倍数可调，配置参数：`boll_std: 2`）；添加带宽收缩/扩张信号标识（收缩阈值：带宽<2%，扩张阈值：带宽>5%）。
- **SAR**：优化转向点计算精度（采用双精度浮点数计算），减少毛刺信号（增加最小波动过滤：价格波动<0.5%时不触发转向）；增加趋势强度系数（公式：`trend_strength = (price - sar)/price`，取值范围0-1）。

#### 震荡类指标优化
- **RSI**：支持动态超买超卖阈值（根据历史波动率自动调整，公式：`overbought = 70 - 10*volatility_ratio`）；增加多周期RSI共振信号（如日线RSI与60分钟RSI同时超卖时标记为强信号）。
- **KDJ**：优化钝化处理逻辑（当K/D值连续3日超买/超卖时，发出强信号并延长信号有效期至5日）；添加J线斜率判断（J线单日涨幅>15%时强化买入信号）。
- **CCI**：扩展计算周期范围（支持14日/20日/30日周期）；增加CCI与价格背离识别（顶背离：价格新高+CCI未新高；底背离：价格新低+CCI未新低）。

#### 量能类指标优化
- **OBV**：引入成交量加权OBV（VOBV，计算公式：`VOBV = OBV * volume_weight`，权重系数可配置），提升量能变化的敏感性；优化信号逻辑（OBV与价格同步突破时确认趋势，突破幅度需>3%）。
- **MFI**：增加资金流向强度分级（弱：20-50，中：50-80，强：80-100）；结合价格趋势过滤无效信号（仅在MA20向上时关注资金流入信号）。

#### ZXM评分指标优化
- **弹性评分**：引入更多子指标（波动率弹性、流动性弹性、价格弹性）；开发自适应阈值系统（根据市场环境动态调整评分阈值，阈值范围：20-80分）。
- **买点评分**：扩展买点子指标（RSI金叉、MACD柱状线翻红、BOLL下轨支撑）；引入机器学习模型优化评分权重（使用XGBoost模型，特征包括历史回测胜率、最大回撤等）。
- **现有功能**：`examples/buypoints.csv`提供示例格式，`bin/buypoint_batch_analyzer.py`已实现基础解析。
- **优化方向**：补充格式验证（如股票代码长度、日期格式）、错误处理（缺失字段、非法值）、批量处理（多文件并行读取）。
- **技术方案**：
  - 使用`pandas.read_csv`读取文件，结合`pandas.DataFrame`的`apply`方法逐行验证。
  - 异常捕获：在`try-except`块中记录错误行号及原因，输出错误报告。
  - 并行处理：使用`concurrent.futures.ThreadPoolExecutor`实现多文件异步读取。

### 3.3 技术指标与评分系统集成情况

以下为全量指标与评分系统集成情况（基于《股票技术分析指标大全.md》整理）：

#### 一、趋势类指标

1. **移动平均线(MA)**
- 评分集成：通过`MA.py`实现不同周期MA计算，注册金叉/死叉/多头排列/空头排列等模式，对应评分权重0.15-0.3
- 模式识别：支持短期(MA5/10)、中期(MA20/30/60)、长期(MA120/250)趋势判断

2. **指数移动平均线(EMA)**
- 评分集成：`EMA.py`实现加权计算，注册快速金叉/滞后死叉等模式，评分权重0.2-0.35
- 模式识别：相比MA减少滞后性，重点识别短期趋势转折点

3. **加权移动平均线(WMA)**
- 评分集成：`WMA.py`通过自定义权重算法，注册短周期趋势变化模式，评分权重0.18-0.28
- 模式识别：侧重10-20周期内价格趋势变化

4. **平滑异同移动平均线(MACD)**
- 评分集成：`MACD.py`实现DIF/DEA/柱状图计算，注册金叉/死叉/顶背离/底背离模式，评分范围0-1
- 模式识别：重点关注零轴上下穿越信号

5. **抛物线转向(SAR)**
- 评分集成：`SAR.py`通过加速因子调整止损位，注册趋势反转模式，评分权重0.25
- 模式识别：识别趋势结束点，触发止盈/止损信号

6. **趋向指标(DMI)**
- 评分集成：`DMI.py`计算+DI/-DI/ADX/ADXR，注册方向线交叉模式，评分权重0.22
- 模式识别：判断趋势强度（ADX>25为强趋势）

7. **均线多空指标(BIAS)**
- 评分集成：`BIAS.py`计算价格偏离MA程度，注册超买(>5%)/超卖(< -5%)模式，评分权重0.15
- 模式识别：预测价格向MA回归可能性

8. **布林带(BOLL)**
- 评分集成：`BOLL.py`计算上下轨，注册带宽收缩/扩张/价格突破边界模式，评分权重0.28
- 模式识别：判断波动率变化与突破方向

#### 二、震荡类指标

1. **相对强弱指标(RSI)**
- 评分集成：`RSI.py`实现6/12/24周期计算，注册超买(>70)/超卖(<30)/背离模式，评分范围0-1
- 模式识别：与价格走势配合确认反转点

2. **随机指标(KDJ)**
- 评分集成：`KDJ.py`计算K/D/J线，注册超买(>80)/超卖(<20)/金叉/死叉模式，评分权重0.3
- 模式识别：短期超买超卖信号为主

3. **威廉指标(WR)**
- 评分集成：`WR.py`实现6/10/14周期计算，注册超买(0-20)/超卖(80-100)模式，评分权重0.18
- 模式识别：与KDJ配合确认信号

4. **顺势指标(CCI)**
- 评分集成：`CCI.py`实现14/20周期计算，注册超买(>100)/超卖(< -100)模式，评分权重0.22
- 模式识别：捕捉短线极端行情

5. **动量指标(MTM)**
- 评分集成：`MTM.py`计算价格变动速率，注册加速上涨/减速下跌模式，评分权重0.15
- 模式识别：测量趋势强度变化

6. **变动率(ROC)**
- 评分集成：`ROC.py`计算价格相对变化速率，注册正/负变动率模式，评分权重0.18
- 模式识别：与MTM配合判断动量方向

7. **随机相对强弱指标(StochRSI)**
- 评分集成：`StochRSI.py`增强RSI敏感度，注册超买(>80)/超卖(<20)模式，评分权重0.25
- 模式识别：更早发现RSI背离信号

#### 三、量能类指标

1. **成交量(VOL)**
- 评分集成：`VOL.py`计算量价配合度，注册放量突破/缩量调整模式，评分权重0.3
- 模式识别：确认价格趋势有效性

2. **能量潮(OBV)**
- 评分集成：`OBV.py`计算资金流向，注册突破/背离模式，评分权重0.28
- 模式识别：判断量价一致性

3. **成交量变异率(VOSC)**
- 评分集成：`VOSC.py`计算成交量趋势，注册正/负变异模式，评分权重0.2
- 模式识别：捕捉成交量拐点

4. **资金流向指标(MFI)**
- 评分集成：`MFI.py`计算资金流入流出，注册超买(>80)/超卖(<20)模式，评分权重0.25
- 模式识别：识别价格反转点

5. **成交量指标(VR)**
- 评分集成：`VR.py`计算多空力量对比，注册多头(>160)/空头(<70)模式，评分权重0.22
- 模式识别：判断市场情绪转换点

#### 1. MACD指标
- **评分系统**：通过`get_score`方法实现0-1分制评分，结合金叉/死叉（±0.4）、柱状图正负（±0.2）、柱状图增减（±0.2）等信号加权计算。
- **形态识别**：注册了`macd_golden_cross`（金叉）、`macd_death_cross`（死叉）、`macd_divergence`（背离）3种形态，通过`analyze_pattern`方法分析形态强度和具体信息。

#### 2. KDJ指标
- **评分系统**：通过`register_pattern`方法为每种形态设置`score_impact`（如超买-15.0、金叉+20.0），全局评分系统根据形态影响值综合计算。
- **形态识别**：注册了超买/超卖、金叉/死叉、顶底背离等10种形态，通过`_detect_*`方法检测，形态类型（看涨/看跌）和强度（STRONG/MEDIUM/WEAK）已集成到全局形态注册表。

#### 3. RSI指标
- **评分系统**：通过超买（看跌信号）、超卖（看涨信号）、顶底背离（看跌/看涨）等形态的强度值（归一化后）参与综合评分。
- **形态识别**：实现了超买/超卖（持续2天以上）、顶底背离（价格与RSI趋势背离）等形态检测，返回包含形态名称、时间、强度、描述的结果列表。

#### 4. BOLL指标
- **评分系统**：每种形态设置`score_impact`（如价格突破上轨-15.0、突破下轨+15.0），评分系统根据实时检测到的形态累加影响值。
- **形态识别**：注册了价格触及/突破上下轨、带宽扩大/收缩、W底/M顶等10种形态，通过`_detect_*`方法检测形态并记录持续时间、强度等信息。

#### 5. MA指标
- **评分系统**：支持自适应周期和筹码加权计算，形态（如金叉/死叉）的评分影响通过`register_pattern`配置（具体数值在指标脚本中定义）。
- **形态识别**：注册了金叉、死叉、多周期均线发散/收敛等形态（具体实现详见`MA`类`_register_ma_patterns`方法）

#### 1.2 多周期数据获取模块（已实现）
- **现有功能**：`db/clickhouse_db.py`已实现`get_kline_data`接口，支持指定周期和日期范围查询。
- **优化方向**：补充数据完整性检查（如缺失K线数量统计）、日期范围自动计算（基于买点日期前推1年）。
- **技术方案**：
  - 完整性检查：查询后对比预期数据量（如15min周期每日应含240条数据），记录缺失率。
  - 日期计算：通过`utils.date_utils`的`get_prev_date`函数，从买点日期倒推起始日期。

#### 1.3 周期数据转换模块（基础实现）
- **现有功能**：`utils/period_manager.py`的`convert_period`函数支持15min转30min/60min。
- **优化方向**：提升大批量数据处理性能（如1000只股票的多周期转换）。
- **技术方案**：
  - 向量化计算：使用`pandas`的`resample`方法替代循环，减少计算时间。
  - 缓存机制：对相同周期转换结果（如15min转30min）缓存，避免重复计算。

---

## 三、指标计算与形态识别层（基础功能已具备）
### 目标
扩展多周期独立处理能力，提升指标计算与形态识别的准确性。

### 现有系统依赖
- 指标工厂：`indicators/factory.py`的`create_indicator`方法支持动态创建指标实例（如KDJ、MACD）。
- 形态识别：`analysis/pattern_recognition_analyzer.py`已实现金叉、死叉等基础形态判断。

### 实现步骤
#### 2.1 多周期指标计算引擎（部分实现）
- **现有功能**：单周期指标计算已支持（如日线MACD）。
- **扩展方向**：支持多周期（15min、30min、60min、日线）独立计算，添加并行机制。
- **技术方案**：
  - 多线程并行：为每个周期分配独立线程，使用`threading.Lock`保护共享资源（如指标结果缓存）。
  - 缓存策略：以`(股票代码, 指标名称, 周期)`为键，缓存计算结果，避免重复计算。

#### 2.2 指标形态识别模块（基础实现）
- **现有功能**：支持单周期形态识别（如日线KDJ金叉）。
- **扩展方向**：多周期分类（如15min金叉+日线金叉标记为强信号）、建立形态索引。
- **技术方案**：
  - 多周期关联：为每个形态结果添加周期标签（如`{"pattern":"gold_cross", "period":"30min"}`）。
  - 索引设计：使用本地缓存（内存缓存`MemoryCache`或磁盘缓存`DiskCache`）存储形态结果，以`(股票代码, 买点日期)`为键，快速查询多周期形态。

#### 2.3 指标打分评估模块（已实现）
- **现有功能**：`indicators/scoring_framework.py`支持单周期指标打分（如KDJ金叉得1分）。
- **优化方向**：多周期独立评分（如30min金叉得2分，日线金叉得3分）、算法优化（引入加权评分）。
- **技术方案**：
  - 周期权重配置：在`config/buypoints_config.json`中定义周期权重（如`{"15min":1, "30min":2, "日线":3}`）。
  - 动态评分：结合形态类型（金叉/死叉）和周期权重，计算综合得分（`score = 形态基础分 × 周期权重`）。

---

## 四、共性特征提取层（待实现）
### 目标
从多股票买点中提取共性指标形态，为策略生成提供依据。

### 现有系统依赖
- 指标形态结果：依赖指标计算与形态识别层的输出（已缓存于Redis）。

### 实现步骤
#### 3.1 买点特征统计模块
- **目标**：统计每个买点在各周期下命中的指标形态。
- **技术方案**：
  - 数据聚合：从Redis读取所有股票的买点形态数据，按`(周期, 指标, 形态)`分组统计。
  - 重要性评估：使用TF-IDF算法计算特征重要性（出现频率高且在少数股票中出现的特征更重要）。

#### 3.2 共性指标提取模块
- **目标**：识别多股票共同命中的指标形态，支持阈值筛选。
- **技术方案**：
  - 命中率计算：统计形态在所有股票中的命中比例（如`命中率 = 命中股票数 / 总股票数`）。
  - 排序与筛选：按命中率降序排序，通过配置文件（`config/buypoints_config.json`）设置阈值（如≥80%）。

#### 3.3 特征组合优化模块
- **目标**：优化共性指标组合，减少冗余。
- **技术方案**：
  - 相关性分析：使用`pandas.corr`计算形态间的相关性，剔除高相关（如ρ>0.8）的冗余形态。
  - 组合评分：基于形态重要性和相关性，计算组合得分（`组合得分 = Σ(形态重要性) × (1 - 平均相关性)`）。

---

## 五、策略生成与验证层（待实现）
### 目标
将共性特征转换为可执行的选股策略，并验证其有效性。

### 现有系统依赖
- 策略模板：`bin/strategy_generator.py`已提供基础策略代码模板。
- 回测工具：`bin/backtest.py`支持策略回测与性能评估。

### 实现步骤
#### 4.1 策略条件生成模块
- **目标**：将共性指标形态转换为策略条件表达式。
- **技术方案**：
  - 表达式引擎：使用`ast`模块解析形态规则（如`"30min_MACD金叉"`转换为`"MACD('30min').cross_up()"`）。
  - 多周期组合：支持逻辑运算符（AND/OR）组合多周期条件（如`"30min金叉 AND 日线金叉"`）。

#### 4.2 策略代码生成模块
- **目标**：基于模板生成可执行的策略代码。
- **技术方案**：
  - 模板引擎：使用`Jinja2`渲染策略模板，填充条件表达式和参数（如`threshold=0.8`）。
  - 参数调整：通过`config/strategies/backtest_strategy.yaml`配置参数范围，支持自动调优。

#### 4.3 策略回测验证模块
- **目标**：验证策略在历史数据中的表现。
- **技术方案**：
  - 复现率评估：计算策略选出的买点与原始买点的重合比例（`复现率 = 重合点数 / 原始点数`）。
  - 性能指标：计算年化收益率、最大回撤等（复用`bin/backtest.py`的`calculate_performance`方法）。

---

## 六、用户界面与输出层（待实现）
### 目标
提供友好的命令行工具、多格式报告及可配置工作流。

### 现有系统依赖
- 命令行基础：`bin/buypoint_batch_analyzer.py`已支持基础参数解析。

### 实现步骤
#### 5.1 命令行工具开发
- **目标**：扩展功能，支持批处理与进度显示。
- **技术方案**：
  - 参数扩展：添加`--batch-size`（批处理大小）、`--progress`（显示进度条）参数。
  - 进度跟踪：使用`tqdm`库实时显示处理进度（如`[======>    ] 60%`）。

#### 5.2 结果报告生成模块
- **目标**：生成多格式（Markdown/HTML/Excel）报告，含可视化图表。
- **技术方案**：
  - 模板渲染：使用`pandas`生成Excel表格，`matplotlib`绘制形态分布图表。
  - 格式转换：通过`pywin32`（Windows）或`libreoffice`（macOS）实现Markdown转HTML。

#### 5.3 工作流配置模块
- **目标**：支持自定义工作流配置。
- **技术方案**：
  - 配置文件：定义`workflow.yaml`，支持选择是否执行特征提取、策略生成等步骤。
  - 预设模板：提供`快速分析`（仅数据处理+指标计算）、`完整分析`（全流程）两种预设。

---

## 七、系统集成与优化层（待完善）
### 目标
优化模块间集成，提升性能与容错能力。

### 现有系统依赖
- 异步通信：使用`asyncio`实现模块间异步调用（如数据处理完成后触发指标计算）。

### 实现步骤
#### 6.1 模块集成与接口统一
- **目标**：统一数据格式与接口。
- **技术方案**：
  - 数据格式：定义`BuypointAnalysisResult`类（含股票代码、买点日期、指标形态、得分等字段）。
  - 异步通信：通过`Redis Pub/Sub`实现模块间消息通知（如`data_processed`事件触发指标计算）。

#### 6.2 性能优化
- **目标**：提升数据处理与计算效率。
- **技术方案**：
  - 并行化：使用`Dask`替代`concurrent.futures`，支持分布式计算。
  - 缓存优化：扩大Redis缓存容量，设置过期时间（如7天）避免内存溢出。

#### 6.3 异常处理与容错机制
- **目标**：保障工作流稳定性。
- **技术方案**：
  - 断点续传：记录每个股票的处理状态（如`processing`/`completed`），异常时从断点恢复。
  - 自动重试：对网络请求（如ClickHouse查询）添加重试机制（最多3次，间隔1s）。

---

## 八、总结
本方案基于现有系统功能，聚焦任务表格中未完成/需优化的环节，通过复用`db`、`indicators`等模块避免重复开发，同时引入并行计算、缓存、异步通信等技术提升性能，最终实现从数据处理到策略验证的完整选股工作流。